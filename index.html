<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
    <title>LuneMusic - Music Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* ✅ DARK THEME (Default) */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #121212;
            --bg-tertiary: #1a1a1a;
            --bg-hover: #242424;
            --accent-primary: #dc143c;
            --accent-secondary: #ff1744;
            --accent-gradient: linear-gradient(135deg, #dc143c, #ff1744);
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #808080;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.6);
            --header-height: 60px;
        }

        /* ✅ LIGHT THEME */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #ebebeb;
            --bg-hover: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-muted: #808080;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 160px;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        @media (max-width: 768px) {
            html { font-size: 14px; }
            body { padding-bottom: 140px; }
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--bg-hover); }

        /* ========== HEADER ========== */
        .header {
            background: var(--bg-secondary);
            height: var(--header-height);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .header-content {
            height: 100%;
            padding: 0 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Left: Menu + Logo */
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Center: Desktop Search (HIDDEN on mobile) */
        .desktop-search {
            display: none;
        }

        @media (min-width: 768px) {
            .desktop-search {
                display: flex;
                flex: 1;
                max-width: 600px;
                margin: 0 auto;
            }
        }

        /* Right: Search Icon + Theme */
        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }

        /* Mobile Search Icon (HIDDEN on desktop) */
        .search-icon-mobile {
            display: flex;
            background: transparent;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1rem;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        @media (min-width: 768px) {
            .search-icon-mobile { display: none; }
        }

        .search-icon-mobile:active { transform: scale(0.9); }

        @media (hover: hover) {
            .search-icon-mobile:hover { background: var(--bg-tertiary); }
        }

        /* Buttons */
        .menu-toggle,
        .theme-toggle {
            background: transparent;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .menu-toggle:active,
        .theme-toggle:active { transform: scale(0.9); }

        @media (hover: hover) {
            .menu-toggle:hover,
            .theme-toggle:hover { background: var(--bg-tertiary); }
        }

        .theme-toggle i { transition: transform 0.3s ease; }
        .theme-toggle:active i { transform: rotate(180deg); }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            flex-shrink: 0;
        }

        .logo i {
            font-size: 1.3rem;
            color: var(--accent-primary);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ========== SEARCH COMPONENTS ========== */
        .search-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .search-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 2.25rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.85rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            outline: none;
            transition: all 0.3s;
        }

        .search-input:focus {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.85rem;
            pointer-events: none;
        }

        .search-clear {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            display: none;
            background: var(--bg-hover);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .search-clear.active { display: flex; }

        @media (hover: hover) {
            .search-clear:hover {
                background: var(--accent-primary);
                color: white;
            }
        }

        .search-select {
            padding: 0.5rem 0.65rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.75rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            outline: none;
        }

        .search-btn {
            padding: 0.5rem 0.85rem;
            border: none;
            border-radius: 20px;
            background: var(--accent-gradient);
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.3);
        }

        .search-btn:active { transform: scale(0.95); }

        /* ========== MOBILE SEARCH MODAL ========== */
        .mobile-search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2500;
            align-items: flex-start;
            justify-content: center;
            padding-top: 20vh;
        }

        .mobile-search-modal.active { display: flex; }

        /* Hide on desktop */
        @media (min-width: 768px) {
            .mobile-search-modal { display: none !important; }
        }

        .mobile-search-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .mobile-search-content {
            position: relative;
            background: var(--bg-secondary);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: slideUp 0.3s ease;
            z-index: 1;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mobile-search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
        }

        .mobile-search-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .mobile-search-body {
            padding: 1.25rem;
        }

        .mobile-search-body .search-select {
            width: 100%;
            margin-top: 0.75rem;
        }

        /* ========== SIDEBAR ========== */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: var(--bg-secondary);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            transition: left 0.3s ease;
            border-right: 1px solid var(--border-color);
        }

        .sidebar.active { left: 0; }

        .sidebar-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            height: 70px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .sidebar-section { margin-bottom: 1.5rem; }

        .sidebar-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            padding: 0 1rem;
            margin-bottom: 0.5rem;
        }

        .sidebar-item {
            width: 100%;
            padding: 0.85rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s;
            text-align: left;
        }

        .sidebar-item:active { transform: scale(0.98); }

        @media (hover: hover) {
            .sidebar-item:hover {
                background: var(--bg-tertiary);
                color: var(--text-primary);
            }
            .sidebar-item:hover i { color: var(--accent-primary); }
        }

        .sidebar-item i {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .sidebar-item span:first-of-type { flex: 1; }
        .sidebar-item .badge { position: static; margin-left: auto; }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .sidebar-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .sidebar-stat {
            text-align: center;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .sidebar-stat .stat-value {
            display: block;
            font-size: 1.1rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
        }

        .sidebar-stat .stat-label {
            display: block;
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .icon-btn-header {
            background: var(--bg-tertiary);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
        }

        .icon-btn-header:active { transform: scale(0.9); }

        @media (hover: hover) {
            .icon-btn-header:hover { background: var(--accent-primary); }
        }

        .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--accent-primary);
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }


        /* NAV TABS */
        .nav-tabs {
            background: var(--bg-secondary);
            padding: 0.5rem;
            display: flex;
            gap: 0.4rem;
            overflow-x: auto;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: var(--header-height);
            z-index: 99;
        }

        .nav-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .tab {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 20px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.3s;
            position: relative;
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--accent-gradient);
            transition: width 0.3s;
            border-radius: 3px 3px 0 0;
        }

        .tab.active::after {
            width: 80%;
        }

        .tab:active {
            transform: scale(0.95);
        }

        .tab.active {
            background: rgba(220, 20, 60, 0.15);
            color: var(--text-primary);
        }

        .tab i {
            font-size: 0.85rem;
        }

        /* CONTAINER */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 0.75rem;
        }

        @media (min-width: 769px) {
            .container {
                padding: 1.5rem 1rem;
            }
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            color: var(--accent-primary);
            font-size: 1.1rem;
        }

        .section-action {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 15px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        @media (hover: hover) {
            .section-action:hover {
                border-color: var(--accent-primary);
                color: var(--accent-primary);
            }
        }

        .section-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .filter-chips {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .filter-chips::-webkit-scrollbar {
            height: 4px;
        }

        .chip {
            padding: 0.4rem 0.9rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .chip.active {
            background: var(--accent-gradient);
            color: white;
            border-color: transparent;
        }

        @media (hover: hover) {
            .chip:hover {
                border-color: var(--accent-primary);
            }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 480px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 0.6rem;
            }
        }

        @media (min-width: 769px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
                gap: 1rem;
            }
        }

        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
                gap: 1.25rem;
            }
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid transparent;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 0;
        }

        .card > * {
            position: relative;
            z-index: 1;
        }

        .card:active {
            transform: scale(0.97);
        }

        @media (hover: hover) {
            .card:hover {
                background: var(--bg-tertiary);
                transform: translateY(-6px);
                box-shadow: var(--shadow-lg);
                border-color: var(--accent-primary);
            }

            .card:hover::before {
                opacity: 0.05;
            }
        }

        .card-img-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            margin-bottom: 0.65rem;
            overflow: hidden;
            border-radius: 6px;
            background: var(--bg-tertiary);
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (hover: hover) {
            .card:hover .card-img {
                transform: scale(1.1);
            }
        }

        .play-overlay {
            position: absolute;
            bottom: 0.4rem;
            right: 0.4rem;
            width: 38px;
            height: 38px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transform: scale(1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 16px rgba(220, 20, 60, 0.5);
            z-index: 10;
        }

        @media (hover: hover) {
            .play-overlay {
                opacity: 0;
                transform: scale(0.8);
            }

            .card:hover .play-overlay {
                opacity: 1;
                transform: scale(1);
            }
        }

        .play-overlay i {
            font-size: 0.9rem;
            color: white;
            margin-left: 2px;
        }

        .card-badge {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            z-index: 5;
        }

        .card-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.3;
        }

        .card-subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card-actions {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.65rem;
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s;
        }

        @media (hover: hover) {
            .card-actions {
                opacity: 0;
                transform: translateY(5px);
            }

            .card:hover .card-actions {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: none;
            padding: 0.4rem;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:active {
            transform: scale(0.9);
            background: var(--accent-primary);
        }

        @media (hover: hover) {
            .icon-btn:hover {
                background: var(--accent-primary);
                transform: scale(1.1);
            }
        }

        .icon-btn.active {
            background: var(--accent-primary);
        }

        .artist-card .card-img,
        .artist-card .card-img-container {
            border-radius: 50%;
        }

        /* MUSIC PLAYER */
        .music-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            z-index: 1000;
            box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
        }

        [data-theme="light"] .music-player {
            box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.08);
        }

        .player-mini {
            padding: 0.75rem;
            cursor: pointer;
        }

        .player-mini-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .player-img {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        [data-theme="light"] .player-img {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .player-details {
            flex: 1;
            min-width: 0;
        }

        .player-details h4 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-details p {
            font-size: 0.75rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-mini-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .control-btn-mini {
            background: transparent;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .control-btn-mini.play-btn {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.4);
        }

        .control-btn-mini:active {
            transform: scale(0.9);
        }

        .player-full {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .player-full.active {
            max-height: 400px;
        }

        .player-full-content {
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .player-progress-wrapper {
            margin-bottom: 1rem;
        }

        .progress-bar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .time {
            font-size: 0.7rem;
            min-width: 38px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .progress {
            flex: 1;
            height: 5px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-filled {
            height: 100%;
            background: var(--accent-gradient);
            border-radius: 3px;
            transition: width 0.1s linear;
            position: relative;
        }

        .player-controls-full {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .control-btn {
            background: transparent;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .control-btn:active {
            transform: scale(0.9);
        }

        @media (hover: hover) {
            .control-btn:hover {
                color: var(--text-primary);
                background: rgba(255, 255, 255, 0.1);
            }

            [data-theme="light"] .control-btn:hover {
                background: rgba(0, 0, 0, 0.05);
            }
        }

        .control-btn.active {
            color: var(--accent-primary);
        }

        .control-btn.play-btn {
            width: 52px;
            height: 52px;
            font-size: 1.3rem;
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 6px 16px rgba(220, 20, 60, 0.4);
        }

        .player-extras-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .player-options {
            display: flex;
            gap: 0.5rem;
        }

        .volume-control {
            display: none;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            max-width: 150px;
        }

        @media (min-width: 769px) {
            .volume-control {
                display: flex;
            }
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .volume-filled {
            height: 100%;
            background: var(--accent-gradient);
            border-radius: 2px;
            width: 100%;
            transition: width 0.1s;
        }

        /* FULLSCREEN PLAYER */
        .fullscreen-player {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .fullscreen-player.active {
            display: flex;
        }

        .fullscreen-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .fullscreen-main {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .fullscreen-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .fullscreen-artwork {
            width: 280px;
            height: 280px;
            border-radius: 16px;
            overflow: hidden;
            margin: 0 auto 2rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            flex-shrink: 0;
        }

        .fullscreen-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .fullscreen-info {
            text-align: center;
            margin-bottom: 2rem;
        }

        .fullscreen-info h2 {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .fullscreen-info p {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .fullscreen-progress {
            margin-bottom: 2rem;
        }

        .fullscreen-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .fullscreen-control-btn {
            background: transparent;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .fullscreen-control-btn:active {
            transform: scale(0.9);
        }

        @media (hover: hover) {
            .fullscreen-control-btn:hover {
                color: var(--text-primary);
                background: rgba(255, 255, 255, 0.1);
            }

            [data-theme="light"] .fullscreen-control-btn:hover {
                background: rgba(0, 0, 0, 0.05);
            }
        }

        .fullscreen-control-btn.active {
            color: var(--accent-primary);
        }

        .fullscreen-control-btn.play-btn-large {
            width: 64px;
            height: 64px;
            font-size: 1.5rem;
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 8px 20px rgba(220, 20, 60, 0.4);
        }

        .fullscreen-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .fullscreen-action-btn {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        [data-theme="light"] .fullscreen-action-btn {
            background: rgba(0, 0, 0, 0.03);
        }

        .fullscreen-action-btn:active {
            transform: scale(0.9);
        }

        @media (hover: hover) {
            .fullscreen-action-btn:hover {
                background: var(--accent-primary);
                color: white;
            }
        }

        .fullscreen-queue {
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
            z-index: 10;
        }

        .fullscreen-queue-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .fullscreen-queue-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .fullscreen-queue-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }

        @media (max-width: 1023px) {
            .fullscreen-queue {
                position: absolute;
                top: 0;
                right: -100%;
                width: 100%;
                max-width: 100%;
                height: 100%;
            }

            .fullscreen-player.queue-open .fullscreen-queue {
                right: 0;
            }

            .fullscreen-player.queue-open .fullscreen-content {
                transform: translateX(-100%);
            }
        }

        @media (min-width: 1024px) {
            .fullscreen-queue {
                position: relative;
                right: 0;
                width: 350px;
                max-width: 350px;
                height: 100%;
            }

            .fullscreen-content {
                transform: translateX(0) !important;
                max-width: 100%;
                padding: 2rem;
            }

            .fullscreen-artwork {
                width: 320px;
                height: 320px;
            }
        }

        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: flex-end;
            justify-content: center;
            padding: 0;
        }

        [data-theme="light"] .modal {
            background: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
        }

        @media (min-width: 769px) {
            .modal {
                align-items: center;
                padding: 1rem;
            }
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 1.25rem;
            border-radius: 16px 16px 0 0;
            max-width: 550px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
        }

        @media (min-width: 769px) {
            .modal-content {
                padding: 1.75rem;
                border-radius: 16px;
                max-height: 90vh;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.15rem;
            font-weight: 700;
        }

        .close-btn {
            background: var(--bg-tertiary);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:active {
            transform: scale(0.9);
        }

        @media (hover: hover) {
            .close-btn:hover {
                background: var(--accent-primary);
                color: white;
            }
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 20px;
            background: var(--accent-gradient);
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.3);
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .queue-item,
        .playlist-item {
            background: var(--bg-tertiary);
            padding: 0.85rem;
            border-radius: 8px;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .queue-item:active,
        .playlist-item:active {
            transform: scale(0.98);
        }

        @media (hover: hover) {
            .queue-item:hover,
            .playlist-item:hover {
                background: var(--bg-hover);
                border-color: var(--accent-primary);
            }
        }

        .queue-item.active {
            background: rgba(220, 20, 60, 0.2);
            border-left: 4px solid var(--accent-primary);
        }

        .queue-img {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .queue-info {
            flex: 1;
            min-width: 0;
        }

        .queue-info .title {
            font-weight: 600;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 0.2rem;
        }

        .queue-info .artist {
            font-size: 0.75rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .input-group {
            margin-bottom: 1.25rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 0.85rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            outline: none;
            transition: all 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            opacity: 0.3;
            color: var(--accent-primary);
        }

        .empty-state p {
            font-size: 0.95rem;
        }

        .loading {
            text-align: center;
            padding: 3rem 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 170px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 0.85rem 1.5rem;
            border-radius: 25px;
            z-index: 9999;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            animation: toastIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            backdrop-filter: blur(10px);
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .toast i {
            color: var(--accent-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .load-more-container {
            text-align: center;
            padding: 2rem 1rem;
            display: none;
        }

        .load-more-container.active {
            display: block;
        }

        .load-more-btn {
            padding: 0.85rem 2rem;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            transition: all 0.3s;
        }

        .load-more-btn:active {
            transform: scale(0.97);
        }

        .load-more-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (hover: hover) {
            .load-more-btn:hover:not(:disabled) {
                border-color: var(--accent-primary);
                background: rgba(220, 20, 60, 0.1);
                color: var(--accent-primary);
            }
        }

        /* Just make sure you have this at end: */
        @media (max-width: 767px) {
            .header-content { padding: 0 0.5rem; gap: 0.5rem; }
            .header-left { gap: 0.5rem; }
            .header-right { gap: 0.4rem; }
        }

        @media (min-width: 768px) {
            .header-content { padding: 0 1rem; }
        }

        /* Mobile pe desktop search HIDE karo */
        @media (max-width: 767px) {
            .desktop-search {
                display: none !important;
            }
        }

        /* Desktop pe mobile search icon HIDE karo */
        @media (min-width: 768px) {
            .search-icon-mobile {
                display: none !important;
            }
        }

        /* Desktop Search - HIDDEN on mobile */
        .desktop-search {
            display: none;
        }

        @media (min-width: 768px) {
            .desktop-search {
                display: flex !important;
                flex: 1;
                max-width: 600px;
                margin: 0 auto;
            }
        }

        /* Mobile Search Icon - HIDDEN on desktop */
        .search-icon-mobile {
            display: flex;
            background: transparent;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1rem;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        @media (min-width: 768px) {
            .search-icon-mobile {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <!-- Left: Menu + Logo -->
            <div class="header-left">
                <button class="menu-toggle" onclick="toggleSidebar()" title="Menu">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <i class="fas fa-compact-disc"></i>
                    <span>LuneMusic</span>
                </div>
            </div>

            <!-- Center: Desktop Search (visible only on desktop) -->
            <div class="search-container desktop-search">
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search songs, artists, albums..." enterkeyhint="search">
                    <div class="search-clear" id="searchClear" onclick="clearSearch()">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                <select class="search-select" id="searchType">
                    <option value="songs">Songs</option>
                    <option value="albums">Albums</option>
                    <option value="artists">Artists</option>
                    <option value="playlists">Playlists</option>
                </select>
                <button class="search-btn" onclick="search()">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <!-- Right: Search Icon (mobile only) + Theme Toggle -->
            <div class="header-right">
                <button class="search-icon-mobile" onclick="openMobileSearch()" title="Search">
                    <i class="fas fa-search"></i>
                </button>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                    <i class="fas fa-sun" id="themeIcon"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Search Modal (Popup) -->
    <div class="mobile-search-modal" id="mobileSearchModal">
        <div class="mobile-search-overlay" onclick="closeMobileSearch()"></div>
        <div class="mobile-search-content">
            <div class="mobile-search-header">
                <h3>Search</h3>
                <button class="close-btn" onclick="closeMobileSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mobile-search-body">
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="searchInputMobile" placeholder="Search songs, artists, albums..." enterkeyhint="search">
                    <div class="search-clear" id="searchClearMobile" onclick="clearMobileSearch()">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                <select class="search-select" id="searchTypeMobile">
                    <option value="songs">Songs</option>
                    <option value="albums">Albums</option>
                    <option value="artists">Artists</option>
                    <option value="playlists">Playlists</option>
                </select>
                <button class="search-btn" onclick="searchMobile()" style="width: 100%; margin-top: 0.75rem;">
                    <i class="fas fa-search"></i>
                    <span>Search</span>
                </button>
            </div>
        </div>
    </div>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-compact-disc"></i>
                    <span>MusicBox</span>
                </div>
                <button class="icon-btn-header" onclick="closeSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sidebar-content">
                <div class="sidebar-section">
                    <h3 class="sidebar-section-title">Library</h3>
                    <button class="sidebar-item" onclick="openRecentlyPlayed(); closeSidebar();">
                        <i class="fas fa-history"></i>
                        <span>Recently Played</span>
                        <span class="badge" id="sidebarRecentBadge" style="display:none;">0</span>
                    </button>
                    <button class="sidebar-item" onclick="openFavorites(); closeSidebar();">
                        <i class="fas fa-heart"></i>
                        <span>Favorites</span>
                        <span class="badge" id="sidebarFavBadge" style="display:none;">0</span>
                    </button>
                    <button class="sidebar-item" onclick="switchTab('my-playlists'); closeSidebar();">
                        <i class="fas fa-list-music"></i>
                        <span>My Playlists</span>
                        <span class="badge" id="sidebarPlaylistBadge" style="display:none;">0</span>
                    </button>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-section-title">Browse</h3>
                    <button class="sidebar-item" onclick="switchTab('home'); closeSidebar();">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </button>
                    <button class="sidebar-item" onclick="loadTrendingPlaylistsTab(); closeSidebar();">
                        <i class="fas fa-fire"></i>
                        <span>Trending Playlists</span>
                    </button>
                    <button class="sidebar-item" onclick="loadTrendingAlbumsTab(); closeSidebar();">
                        <i class="fas fa-compact-disc"></i>
                        <span>Trending Albums</span>
                    </button>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-section-title">Other</h3>
                    <button class="sidebar-item" onclick="openSettings(); closeSidebar();">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </button>
                    <button class="sidebar-item" onclick="switchTab('queue'); closeSidebar();">
                        <i class="fas fa-list-ol"></i>
                        <span>Play Queue</span>
                        <span class="badge" id="sidebarQueueBadge" style="display:none;">0</span>
                    </button>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="sidebar-stats">
                    <div class="sidebar-stat">
                        <span class="stat-value" id="sidebarStatSongs">0</span>
                        <span class="stat-label">Songs</span>
                    </div>
                    <div class="sidebar-stat">
                        <span class="stat-value" id="sidebarStatPlaylists">0</span>
                        <span class="stat-label">Playlists</span>
                    </div>
                    <div class="sidebar-stat">
                        <span class="stat-value" id="sidebarStatFavorites">0</span>
                        <span class="stat-label">Favorites</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs" id="navTabs">
            <button class="tab active" onclick="switchTab('home')">
                <i class="fas fa-home"></i> Home
            </button>
            <button class="tab" onclick="switchTab('trending-playlists')">
                <i class="fas fa-fire"></i> Playlists
            </button>
            <button class="tab" onclick="switchTab('trending-albums')">
                <i class="fas fa-compact-disc"></i> Albums
            </button>
            <button class="tab" onclick="switchTab('search-results')">
                <i class="fas fa-search"></i> Search
            </button>
            <button class="tab" onclick="switchTab('queue')">
                <i class="fas fa-list-ol"></i> Queue
                <span class="badge" id="queueBadge" style="display:none;">0</span>
            </button>
            <button class="tab" onclick="switchTab('my-playlists')">
                <i class="fas fa-heart"></i> My Lists
            </button>
        </div>

        <!-- Main Container -->
        <div class="container">
            <!-- Home Section -->
            <div class="content-section active" id="home">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statSongs">0</div>
                        <div class="stat-label">Songs Played</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statPlaylists">0</div>
                        <div class="stat-label">Playlists</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statFavorites">0</div>
                        <div class="stat-label">Favorites</div>
                    </div>
                </div>

                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-fire"></i>
                        Trending Now
                    </h2>
                    <button class="section-action" onclick="loadTrendingPlaylistsTab()">
                        See All <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="grid" id="trendingNow"></div>

                <div class="section-header" style="margin-top: 2rem;">
                    <h2 class="section-title">
                        <i class="fas fa-compact-disc"></i>
                        Popular Albums
                    </h2>
                    <button class="section-action" onclick="loadTrendingAlbumsTab()">
                        See All <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="grid" id="popularAlbums"></div>

                <div class="section-header" style="margin-top: 2rem;">
                    <h2 class="section-title">
                        <i class="fas fa-star"></i>
                        Editorial Picks
                    </h2>
                    <button class="section-action" onclick="loadTrendingAlbumsTab()">
                        See All <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="grid" id="editorialPicks"></div>

                <div class="section-header" style="margin-top: 2rem;">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Top Charts
                    </h2>
                    <button class="section-action" onclick="loadTrendingPlaylistsTab()">
                        See All <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="grid" id="topCharts"></div>

                <div class="section-header" style="margin-top: 2rem;">
                    <h2 class="section-title">
                        <i class="fas fa-heart"></i>
                        Made For You
                    </h2>
                    <button class="section-action" onclick="loadTrendingPlaylistsTab()">
                        See All <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="grid" id="madeForYou"></div>

                <div style="text-align: center; margin-top: 2rem; padding-bottom: 2rem;">
                    <button class="btn" onclick="loadHome()" style="min-width: 200px;">
                        <i class="fas fa-sync-alt"></i>
                        Refresh All
                    </button>
                </div>
            </div>

            <!-- Trending Playlists Section -->
            <div class="content-section" id="trending-playlists">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-fire"></i>
                        Trending Playlists
                    </h2>
                </div>
                <div class="filter-chips">
                    <div class="chip active" onclick="filterPlaylists('all')">All</div>
                    <div class="chip" onclick="filterPlaylists('hindi')">Hindi</div>
                    <div class="chip" onclick="filterPlaylists('english')">English</div>
                    <div class="chip" onclick="filterPlaylists('punjabi')">Punjabi</div>
                    <div class="chip" onclick="filterPlaylists('romantic')">Romantic</div>
                    <div class="chip" onclick="filterPlaylists('party')">Party</div>
                </div>
                <div class="grid" id="trendingPlaylistsGrid"></div>
            </div>

            <!-- Trending Albums Section -->
            <div class="content-section" id="trending-albums">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-compact-disc"></i>
                        Trending Albums
                    </h2>
                </div>
                <div class="filter-chips">
                    <div class="chip active" onclick="filterAlbums('all')">All</div>
                    <div class="chip" onclick="filterAlbums('2024')">2024</div>
                    <div class="chip" onclick="filterAlbums('2023')">2023</div>
                    <div class="chip" onclick="filterAlbums('bollywood')">Bollywood</div>
                </div>
                <div class="grid" id="trendingAlbumsGrid"></div>
            </div>

            <!-- Search Results Section -->
            <div class="content-section" id="search-results">
                <div class="section-header">
                    <h2 class="section-title" id="searchResultsTitle">
                        <i class="fas fa-search"></i>
                        Search Results
                    </h2>
                </div>
                <div class="section-info" id="searchResultsInfo"></div>
                <div class="grid" id="searchResultsGrid"></div>
                <div class="load-more-container" id="loadMoreContainer">
                    <button class="load-more-btn" id="loadMoreBtn" onclick="loadMore()">
                        <i class="fas fa-chevron-down"></i>
                        <span id="loadMoreText">Load More</span>
                    </button>
                </div>
            </div>

            <!-- Queue Section -->
            <div class="content-section" id="queue">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-list-ol"></i>
                        Play Queue
                    </h2>
                    <button class="section-action" onclick="clearQueue()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
                <div class="section-info">
                    <span><i class="fas fa-music"></i> <span id="queueCount">0</span> songs</span>
                </div>
                <div id="queueList"></div>
            </div>

            <!-- My Playlists Section -->
            <div class="content-section" id="my-playlists">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-heart"></i>
                        My Playlists
                    </h2>
                </div>
                <button class="btn" style="margin-bottom: 1.5rem; width: 100%;" onclick="showCreatePlaylist()">
                    <i class="fas fa-plus"></i>
                    Create New Playlist
                </button>
                <div class="grid" id="myPlaylistsGrid"></div>
            </div>
        </div>

        <!-- Music Player -->
        <div class="music-player">
            <div class="player-mini" onclick="togglePlayerExpand()">
                <div class="player-mini-content">
                    <img src="https://via.placeholder.com/50" alt="Art" class="player-img" id="playerImgMini">
                    <div class="player-details">
                        <h4 id="playerTitleMini">No song playing</h4>
                        <p id="playerArtistMini">Select a song to play</p>
                    </div>
                    <div class="player-mini-controls">
                        <button class="control-btn-mini" onclick="toggleFavorite(event)">
                            <i class="far fa-heart" id="favoriteIcon"></i>
                        </button>
                        <button class="control-btn-mini play-btn" id="playPauseBtnMini" onclick="togglePlayPause(event)">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="control-btn-mini" onclick="nextSong(event)">
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="player-full" id="playerFull">
                <div class="player-full-content">
                    <div class="player-progress-wrapper">
                        <div class="progress-bar">
                            <span class="time" id="currentTime">0:00</span>
                            <div class="progress" id="progressBar" onclick="seekSong(event)">
                                <div class="progress-filled" id="progressFilled"></div>
                            </div>
                            <span class="time" id="duration">0:00</span>
                        </div>
                    </div>

                    <div class="player-controls-full">
                        <button class="control-btn" onclick="toggleShuffle()" id="shuffleBtn" title="Shuffle">
                            <i class="fas fa-random"></i>
                        </button>
                        <button class="control-btn" onclick="previousSong()">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="control-btn play-btn" id="playPauseBtn" onclick="togglePlayPause(event)">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="control-btn" onclick="nextSong(event)">
                            <i class="fas fa-step-forward"></i>
                        </button>
                        <button class="control-btn" onclick="toggleRepeat()" id="repeatBtn" title="Repeat">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>

                    <div class="player-extras-row">
                        <div class="player-options">
                            <button class="control-btn" onclick="openFullscreenPlayer()" title="Full Screen">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="control-btn" onclick="openAddToPlaylist()" title="Add to Playlist">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="control-btn" onclick="downloadCurrentSong()" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="control-btn" onclick="shareCurrentSong()" title="Share">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                        <div class="volume-control">
                            <i class="fas fa-volume-up"></i>
                            <div class="volume-slider" onclick="setVolume(event)">
                                <div class="volume-filled" id="volumeFilled"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fullscreen Player -->
        <div class="fullscreen-player" id="fullscreenPlayer">
            <div class="fullscreen-header">
                <button class="icon-btn-header" onclick="closeFullscreenPlayer()">
                    <i class="fas fa-chevron-down"></i>
                </button>
                <h3>Now Playing</h3>
                <button class="icon-btn-header" onclick="toggleFullscreenQueue()">
                    <i class="fas fa-list" id="fullscreenQueueIcon"></i>
                </button>
            </div>

            <div class="fullscreen-main" id="fullscreenMain">
                <div class="fullscreen-content">
                    <div class="fullscreen-artwork" id="fullscreenArtwork">
                        <img src="https://via.placeholder.com/400" alt="Album Art" id="fullscreenImg">
                    </div>
                    <div class="fullscreen-info">
                        <h2 id="fullscreenTitle">Song Title</h2>
                        <p id="fullscreenArtist">Artist Name</p>
                    </div>

                    <div class="fullscreen-progress">
                        <div class="progress-bar">
                            <span class="time" id="fullscreenCurrentTime">0:00</span>
                            <div class="progress" id="fullscreenProgressBar" onclick="seekSongFullscreen(event)">
                                <div class="progress-filled" id="fullscreenProgressFilled"></div>
                            </div>
                            <span class="time" id="fullscreenDuration">0:00</span>
                        </div>
                    </div>

                    <div class="fullscreen-controls">
                        <button class="fullscreen-control-btn" onclick="toggleShuffle()" id="fullscreenShuffleBtn" title="Shuffle">
                            <i class="fas fa-random"></i>
                        </button>
                        <button class="fullscreen-control-btn" onclick="previousSong()">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="fullscreen-control-btn play-btn-large" id="fullscreenPlayPauseBtn" onclick="togglePlayPause(event)">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="fullscreen-control-btn" onclick="nextSong(event)">
                            <i class="fas fa-step-forward"></i>
                        </button>
                        <button class="fullscreen-control-btn" onclick="toggleRepeat()" id="fullscreenRepeatBtn" title="Repeat">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>

                    <div class="fullscreen-actions">
                        <button class="fullscreen-action-btn" onclick="toggleFavorite(event)" title="Favorite">
                            <i class="far fa-heart" id="fullscreenFavoriteIcon"></i>
                        </button>
                        <button class="fullscreen-action-btn" onclick="openAddToPlaylist()" title="Add to Playlist">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="fullscreen-action-btn" onclick="downloadCurrentSong()" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="fullscreen-action-btn" onclick="shareCurrentSong()" title="Share">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="fullscreen-queue" id="fullscreenQueue">
                    <div class="fullscreen-queue-header">
                        <h3>Up Next</h3>
                        <button class="icon-btn-header" onclick="clearQueue()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="fullscreen-queue-list" id="fullscreenQueueList"></div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div class="modal" id="playlistModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">My Playlists</h3>
                    <button class="close-btn" onclick="closeModal('playlistModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <button class="btn" style="width: 100%; margin-bottom: 1.25rem;" onclick="showCreatePlaylist()">
                    <i class="fas fa-plus"></i>
                    Create New Playlist
                </button>
                <div id="playlistsList"></div>
            </div>
        </div>

        <div class="modal" id="createPlaylistModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Create Playlist</h3>
                    <button class="close-btn" onclick="closeModal('createPlaylistModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="input-group">
                    <label>Playlist Name</label>
                    <input type="text" id="playlistName" placeholder="Enter playlist name">
                </div>
                <div class="input-group">
                    <label>Description (Optional)</label>
                    <input type="text" id="playlistDesc" placeholder="Add a description">
                </div>
                <button class="btn" style="width: 100%;" onclick="createPlaylist()">
                    <i class="fas fa-check"></i>
                    Create Playlist
                </button>
            </div>
        </div>

        <div class="modal" id="addToPlaylistModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Add to Playlist</h3>
                    <button class="close-btn" onclick="closeModal('addToPlaylistModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="addToPlaylistList"></div>
            </div>
        </div>

        <div class="modal" id="viewPlaylistModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="viewPlaylistTitle">Playlist</h3>
                    <button class="close-btn" onclick="closeModal('viewPlaylistModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="viewPlaylistSongs"></div>
            </div>
        </div>

        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Settings</h3>
                    <button class="close-btn" onclick="closeModal('settingsModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="input-group">
                    <label>Audio Quality</label>
                    <select id="audioQuality" onchange="saveSettings()">
                        <option value="low">Low (96kbps)</option>
                        <option value="medium">Medium (160kbps)</option>
                        <option value="high" selected>High (320kbps)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Playback Speed</label>
                    <select id="playbackSpeed" onchange="changePlaybackSpeed()">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>Normal</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
                <button class="btn" style="width: 100%; margin-top: 1rem;" onclick="clearAllData()">
                    <i class="fas fa-trash"></i>
                    Clear All Data
                </button>
            </div>
        </div>

        <div class="modal" id="favoritesModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Favorites</h3>
                    <button class="close-btn" onclick="closeModal('favoritesModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="favoritesList"></div>
            </div>
        </div>

        <div class="modal" id="recentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Recently Played</h3>
                    <button class="close-btn" onclick="closeModal('recentModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="recentList"></div>
            </div>
        </div>

        <audio id="audioPlayer"></audio>

    <script>
    const API_BASE = 'https://saavn.sumit.co';

    let currentSong = null;
    let queue = [];
    let currentIndex = -1;
    let playlists = JSON.parse(localStorage.getItem('playlists')) || [];
    let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    let recentlyPlayed = JSON.parse(localStorage.getItem('recentlyPlayed')) || [];
    let isPlaying = false;
    let isShuffleOn = false;
    let repeatMode = 'off';
    let playerExpanded = false;
    const audio = document.getElementById('audioPlayer');
    let currentPlaylistForAdd = null;
    let wakeLock = null; // ✅ NEW

    let currentContext = {
        type: null,
        id: null,
        url: null,
        name: null,
        songs: [],
        currentPage: 0,
        totalSongs: 0,
        hasMore: false,
        isLoading: false
    };

    let settings = JSON.parse(localStorage.getItem('settings')) || {
        audioQuality: 'high',
        playbackSpeed: 1
    };

    // ✅ BACKGROUND PLAYBACK - Wake Lock
    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock activated');
                wakeLock.addEventListener('release', () => {
                    console.log('Wake Lock released');
                });
            } catch (err) {
                console.log('Wake Lock not supported:', err);
            }
        }
    }

    function releaseWakeLock() {
        if (wakeLock !== null) {
            wakeLock.release().then(() => {
                wakeLock = null;
            });
        }
    }

    // ✅ Re-request wake lock when page becomes visible
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') {
            await requestWakeLock();
        }
    });

    // ✅ IMPROVED MEDIA SESSION
        function setupMediaSession(song) {
            if ('mediaSession' in navigator) {
                const imageUrl = song.image?.[2]?.url || song.image?.[1]?.url || 'https://via.placeholder.com/512';
                const artistName = song.artists?.primary?.map(a => a.name).join(', ') || 'Unknown Artist';

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.name || 'Unknown Song',
                    artist: artistName,
                    album: song.album?.name || 'MusicBox',
                    artwork: [
                        { src: imageUrl, sizes: '96x96', type: 'image/jpeg' },
                        { src: imageUrl, sizes: '128x128', type: 'image/jpeg' },
                        { src: imageUrl, sizes: '192x192', type: 'image/jpeg' },
                        { src: imageUrl, sizes: '256x256', type: 'image/jpeg' },
                        { src: imageUrl, sizes: '384x384', type: 'image/jpeg' },
                        { src: imageUrl, sizes: '512x512', type: 'image/jpeg' }
                    ]
                });

                // ✅ PLAY HANDLER
                navigator.mediaSession.setActionHandler('play', () => {
                    audio.play()
                        .then(() => {
                            isPlaying = true;
                            updatePlayPauseButtons();
                            requestWakeLock();
                        })
                        .catch(err => {
                            console.error('Media session play error:', err);
                        });
                });

                // ✅ PAUSE HANDLER
                navigator.mediaSession.setActionHandler('pause', () => {
                    audio.pause();
                    isPlaying = false;
                    updatePlayPauseButtons();
                    releaseWakeLock();
                });

                navigator.mediaSession.setActionHandler('previoustrack', () => {
                    previousSong();
                });

                navigator.mediaSession.setActionHandler('nexttrack', () => {
                    nextSong();
                });

                navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                    audio.currentTime = Math.max(audio.currentTime - (details.seekOffset || 10), 0);
                });

                navigator.mediaSession.setActionHandler('seekforward', (details) => {
                    audio.currentTime = Math.min(audio.currentTime + (details.seekOffset || 10), audio.duration);
                });

                navigator.mediaSession.setActionHandler('seekto', (details) => {
                    if (details.fastSeek && 'fastSeek' in audio) {
                        audio.fastSeek(details.seekTime);
                    } else {
                        audio.currentTime = details.seekTime;
                    }
                });

                updatePositionState();
            }
        }

    function updatePositionState() {
        if ('setPositionState' in navigator.mediaSession) {
            if (audio.duration && !isNaN(audio.duration)) {
                navigator.mediaSession.setPositionState({
                    duration: audio.duration,
                    playbackRate: audio.playbackRate,
                    position: audio.currentTime
                });
            }
        }
    }

    // ✅ WINDOW ONLOAD
    window.onload = function() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        const themeIcon = document.getElementById('themeIcon');
        if (themeIcon) {
            themeIcon.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }

        loadHome();
        setupAudioListeners();
        updateMyPlaylistsDisplay();
        setupSearchListener();
        setupMobileSearchListener();
        updateStats();
        updateBadges();
        loadSettings();
    };

    // ✅ IMPROVED AUDIO LISTENERS
        function setupAudioListeners() {
            // ✅ TIME UPDATE
            audio.addEventListener('timeupdate', () => {
                updateProgress();
                updatePositionState();
            });

            // ✅ SONG ENDED
            audio.addEventListener('ended', handleSongEnd);

            // ✅ METADATA LOADED
            audio.addEventListener('loadedmetadata', function() {
                const duration = document.getElementById('duration');
                const fullscreenDuration = document.getElementById('fullscreenDuration');

                if (duration) duration.textContent = formatTime(audio.duration);
                if (fullscreenDuration) fullscreenDuration.textContent = formatTime(audio.duration);

                updatePositionState();
            });

            // ✅ PLAY EVENT - Update state when audio starts playing
            audio.addEventListener('play', () => {
                isPlaying = true;
                updatePlayPauseButtons();
            });

            // ✅ PAUSE EVENT - Update state when audio pauses
            audio.addEventListener('pause', () => {
                // Only update if not ended (to prevent conflicts with next song)
                if (!audio.ended) {
                    isPlaying = false;
                    updatePlayPauseButtons();
                }
            });

            // ✅ ERROR HANDLING
            audio.addEventListener('error', (e) => {
                console.error('Audio error:', e);
                isPlaying = false;
                updatePlayPauseButtons();
                showToast('Playback error', 'error');
            });

            // ✅ WAITING/BUFFERING
            audio.addEventListener('waiting', () => {
                console.log('Buffering...');
            });

            // ✅ CAN PLAY
            audio.addEventListener('canplay', () => {
                console.log('Can play');
            });
        }

    function handleSongEnd() {
        if (repeatMode === 'one') {
            audio.currentTime = 0;
            audio.play();
        } else {
            nextSong();
        }
    }

    function setupSearchListener() {
        const searchInput = document.getElementById('searchInput');

        searchInput.addEventListener('input', function(e) {
            const clearBtn = document.getElementById('searchClear');
            if (e.target.value.length > 0) {
                clearBtn.classList.add('active');
            } else {
                clearBtn.classList.remove('active');
            }
        });

        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                search();
            }
        });
    }

    function setupMobileSearchListener() {
        const searchInputMobile = document.getElementById('searchInputMobile');
        if (!searchInputMobile) return;

        searchInputMobile.addEventListener('input', function(e) {
            const clearBtn = document.getElementById('searchClearMobile');
            if (e.target.value.length > 0) {
                clearBtn.classList.add('active');
            } else {
                clearBtn.classList.remove('active');
            }
        });

        searchInputMobile.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchMobile();
            }
        });
    }

    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchClear').classList.remove('active');
    }

    function clearMobileSearch() {
        document.getElementById('searchInputMobile').value = '';
        document.getElementById('searchClearMobileSearchClearMobile').classList.remove('active');
    }

    function search() {
        const query = document.getElementById('searchInput').value.trim();
        const type = document.getElementById('searchType').value;

        if (!query) {
            showToast('Please enter a search term', 'warning');
            return;
        }

        performSearch(query, type);
    }

    function searchMobile() {
        const query = document.getElementById('searchInputMobile').value.trim();
        const type = document.getElementById('searchTypeMobile').value;

        if (!query) {
            showToast('Please enter a search term', 'warning');
            return;
        }

        closeMobileSearch();
        performSearch(query, type);
    }

        async function performSearch(query, type) {
            currentContext = {
                type: 'search',
                id: null,
                url: null,
                name: query,
                songs: [],
                albums: [],
                playlists: [],
                artists: [],
                currentPage: 0,
                totalSongs: 0,
                hasMore: false,
                isLoading: false,
                searchType: type,
                query: query,
                loadedIds: new Set()
            };

            switchTab('search-results');
            showLoading('searchResultsGrid');
            document.getElementById('loadMoreContainer').classList.remove('active');

            let endpoint = '';
            switch(type) {
                case 'songs': 
                    endpoint = `/api/search/songs?query=${encodeURIComponent(query)}&page=0&limit=20`; 
                    break;
                case 'albums': 
                    endpoint = `/api/search/albums?query=${encodeURIComponent(query)}&page=0&limit=20`; 
                    break;
                case 'artists': 
                    endpoint = `/api/search/artists?query=${encodeURIComponent(query)}&page=0&limit=20`; 
                    break;
                case 'playlists': 
                    endpoint = `/api/search/playlists?query=${encodeURIComponent(query)}&page=0&limit=20`; 
                    break;
                default: 
                    endpoint = `/api/search?query=${encodeURIComponent(query)}&page=0&limit=20`;
            }

            const data = await fetchAPI(endpoint);

            if (data?.data?.results && data.data.results.length > 0) {
                document.getElementById('searchResultsTitle').innerHTML = `<i class="fas fa-search"></i> "${query}"`;

                const total = data.data.total || data.data.results.length;
                currentContext.totalSongs = total;
                currentContext.hasMore = data.data.results.length >= 20;

                if (type === 'albums') {
                    currentContext.albums = data.data.results;
                    data.data.results.forEach(a => currentContext.loadedIds.add(a.id));
                    displayAlbums(data.data.results, 'searchResultsGrid');
                } else if (type === 'playlists') {
                    currentContext.playlists = data.data.results;
                    data.data.results.forEach(p => currentContext.loadedIds.add(p.id));
                    displayPlaylists(data.data.results, 'searchResultsGrid');
                } else if (type === 'artists') {
                    currentContext.artists = data.data.results;
                    data.data.results.forEach(a => currentContext.loadedIds.add(a.id));
                    displayArtists(data.data.results, 'searchResultsGrid');
                } else if (type === 'songs') {
                    currentContext.songs = data.data.results;
                    data.data.results.forEach(s => currentContext.loadedIds.add(s.id));
                    displaySongs(data.data.results, 'searchResultsGrid');
                } else {
                    displayMixedResults(data.data.results, 'searchResultsGrid');
                }

                document.getElementById('searchResultsInfo').innerHTML = `
                    <span><i class="fas fa-check-circle"></i> Showing ${data.data.results.length} results</span>
                `;

                if (currentContext.hasMore) {
                    document.getElementById('loadMoreContainer').classList.add('active');
                }
            } else {
                document.getElementById('searchResultsGrid').innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>No results found</p></div>';
                document.getElementById('searchResultsInfo').innerHTML = '';
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');

            if (sidebar.classList.contains('active')) {
                if (window.innerWidth < 1024) {
                    document.body.style.overflow = 'hidden';
                }
            } else {
                document.body.style.overflow = '';
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        async function fetchAPI(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API Error:', error);
                showToast('Network error', 'error');
                return null;
            }
        }

        function normalizeBackupAPIResponse(songs) {
            return songs.map(song => {
                const normalizedImage = song.image?.map(img => ({
                    quality: img.quality,
                    url: img.link
                })) || [];

                const normalizedDownloadUrl = song.downloadUrl?.map(dl => ({
                    quality: dl.quality,
                    url: dl.link
                })) || [];

                const artistNames = song.primaryArtists?.split(', ') || [];
                const artistIds = song.primaryArtistsId?.split(', ') || [];

                const primaryArtists = artistNames.map((name, index) => ({
                    id: artistIds[index] || '',
                    name: name.trim()
                }));

                return {
                    id: song.id,
                    name: song.name,
                    type: song.type || 'song',
                    album: song.album,
                    year: song.year,
                    releaseDate: song.releaseDate,
                    duration: parseInt(song.duration) || 0,
                    label: song.label,
                    explicitContent: song.explicitContent,
                    playCount: song.playCount,
                    language: song.language,
                    hasLyrics: song.hasLyrics === 'true',
                    url: song.url,
                    copyright: song.copyright,
                    image: normalizedImage,
                    downloadUrl: normalizedDownloadUrl,
                    artists: {
                        primary: primaryArtists,
                        featured: [],
                        all: primaryArtists
                    }
                };
            });
        }

        async function loadHome() {
            showLoading('trendingNow');
            showLoading('popularAlbums');
            showLoading('editorialPicks');
            showLoading('topCharts');
            showLoading('madeForYou');

            await Promise.all([
                loadTrendingNow(),
                loadPopularAlbums(),
                loadEditorialPicks(),
                loadTopCharts(),
                loadMadeForYou()
            ]);
        }

        async function loadTrendingNow() {
            const data = await fetchAPI('/api/search/playlists?query=trending viral&page=0&limit=10');
            if (data?.data?.results) {
                displayPlaylists(data.data.results.slice(0, 6), 'trendingNow');
            } else {
                document.getElementById('trendingNow').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Failed to load</p></div>';
            }
        }

        async function loadPopularAlbums() {
            const data = await fetchAPI('/api/search/albums?query=latest bollywood 2024&page=0&limit=10');
            if (data?.data?.results) {
                displayAlbums(data.data.results.slice(0, 6), 'popularAlbums');
            } else {
                document.getElementById('popularAlbums').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Failed to load</p></div>';
            }
        }

        async function loadEditorialPicks() {
            const data = await fetchAPI('/api/search/albums?query=fresh music 2024&page=0&limit=10');
            if (data?.data?.results) {
                displayAlbums(data.data.results.slice(0, 6), 'editorialPicks');
            } else {
                document.getElementById('editorialPicks').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Failed to load</p></div>';
            }
        }

        async function loadTopCharts() {
            try {
                const [data1, data2, data3, data4] = await Promise.all([
                    fetchAPI('/api/search/playlists?query=Most Streamed Love Songs Hindi&page=0&limit=3'),
                    fetchAPI('/api/search/playlists?query=Most Streamed Love Songs English&page=0&limit=3'),
                    fetchAPI('/api/search/playlists?query=Trending Today&page=0&limit=3'),
                    fetchAPI('/api/search/playlists?query=Most Searched Songs Hindi&page=0&limit=3')
                ]);

                let combinedResults = [];

                if (data1?.data?.results?.length) combinedResults.push(data1.data.results[0]);
                if (data2?.data?.results?.length) combinedResults.push(data2.data.results[0]);
                if (data3?.data?.results?.length) combinedResults.push(data3.data.results[0]);
                if (data4?.data?.results?.length) combinedResults.push(data4.data.results[0]);

                if (combinedResults.length < 6) {
                    const allResults = [
                        ...(data1?.data?.results || []).slice(1),
                        ...(data2?.data?.results || []).slice(1),
                        ...(data3?.data?.results || []).slice(1),
                        ...(data4?.data?.results || []).slice(1)
                    ];

                    const addedIds = new Set(combinedResults.map(r => r.id));
                    const uniqueResults = allResults.filter(r => !addedIds.has(r.id));
                    combinedResults = [...combinedResults, ...uniqueResults].slice(0, 6);
                }

                if (combinedResults.length > 0) {
                    displayPlaylists(combinedResults, 'topCharts');
                } else {
                    const fallbackData = await fetchAPI('/api/search/playlists?query=top 100 hindi&page=0&limit=6');
                    if (fallbackData?.data?.results) {
                        displayPlaylists(fallbackData.data.results.slice(0, 6), 'topCharts');
                    } else {
                        document.getElementById('topCharts').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Failed to load</p></div>';
                    }
                }
            } catch (error) {
                document.getElementById('topCharts').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Failed to load</p></div>';
            }
        }

        async function loadMadeForYou() {
            const data = await fetchAPI('/api/search/playlists?query=romantic love hindi&page=0&limit=10');
            if (data?.data?.results) {
                displayPlaylists(data.data.results.slice(0, 6), 'madeForYou');
            } else {
                document.getElementById('madeForYou').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Failed to load</p></div>';
            }
        }

        async function loadTrendingPlaylists() {
            showLoading('trendingPlaylistsGrid');
            const data = await fetchAPI('/api/search/playlists?query=trending&page=0&limit=20');
            if (data?.data?.results) {
                displayPlaylists(data.data.results, 'trendingPlaylistsGrid');
            }
        }

        function loadTrendingPlaylistsTab() {
            switchTab('trending-playlists');
            if (!document.getElementById('trendingPlaylistsGrid').innerHTML) {
                loadTrendingPlaylists();
            }
        }

        async function loadTrendingAlbums() {
            showLoading('trendingAlbumsGrid');
            const data = await fetchAPI('/api/search/albums?query=2024&page=0&limit=20');
            if (data?.data?.results) {
                displayAlbums(data.data.results, 'trendingAlbumsGrid');
            }
        }

        function loadTrendingAlbumsTab() {
            switchTab('trending-albums');
            if (!document.getElementById('trendingAlbumsGrid').innerHTML) {
                loadTrendingAlbums();
            }
        }

        async function filterPlaylists(category) {
            document.querySelectorAll('#trending-playlists .chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            showLoading('trendingPlaylistsGrid');
            const query = category === 'all' ? 'trending' : category;
            const data = await fetchAPI(`/api/search/playlists?query=${query}&page=0&limit=20`);
            if (data?.data?.results) {
                displayPlaylists(data.data.results, 'trendingPlaylistsGrid');
            }
        }

        async function filterAlbums(category) {
            document.querySelectorAll('#trending-albums .chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            showLoading('trendingAlbumsGrid');
            const query = category === 'all' ? '2024' : category;
            const data = await fetchAPI(`/api/search/albums?query=${query}&page=0&limit=20`);
            if (data?.data?.results) {
                displayAlbums(data.data.results, 'trendingAlbumsGrid');
            }
        }

        async function loadMore() {
            if (currentContext.isLoading || !currentContext.hasMore) return;
            if (currentContext.useBackupAPI) {
                document.getElementById('loadMoreContainer').classList.remove('active');
                showToast('All songs loaded', 'info');
                return;
            }

            const btn = document.getElementById('loadMoreBtn');
            const btnText = document.getElementById('loadMoreText');

            currentContext.isLoading = true;
            btn.disabled = true;
            btnText.textContent = 'Loading...';
            currentContext.currentPage++;

            let endpoint = '';
            let data = null;

            if (currentContext.type === 'search') {
                const { query, searchType, currentPage } = currentContext;

                switch(searchType) {
                    case 'songs': 
                        endpoint = `/api/search/songs?query=${encodeURIComponent(query)}&page=${currentPage}&limit=20`; 
                        break;
                    case 'albums': 
                        endpoint = `/api/search/albums?query=${encodeURIComponent(query)}&page=${currentPage}&limit=20`; 
                        break;
                    case 'artists': 
                        endpoint = `/api/search/artists?query=${encodeURIComponent(query)}&page=${currentPage}&limit=20`; 
                        break;
                    case 'playlists': 
                        endpoint = `/api/search/playlists?query=${encodeURIComponent(query)}&page=${currentPage}&limit=20`; 
                        break;
                    default: 
                        endpoint = `/api/search?query=${encodeURIComponent(query)}&page=${currentPage}&limit=20`;
                }

                data = await fetchAPI(endpoint);

                if (data?.data?.results && data.data.results.length > 0) {
                    let newItems = [];

                    data.data.results.forEach(item => {
                        if (!currentContext.loadedIds.has(item.id)) {
                            newItems.push(item);
                            currentContext.loadedIds.add(item.id);
                        }
                    });

                    if (newItems.length === 0) {
                        currentContext.isLoading = false;
                        btn.disabled = false;
                        btnText.textContent = 'Load More';
                        setTimeout(() => loadMore(), 100);
                        return;
                    }

                    if (searchType === 'songs') {
                        currentContext.songs = [...currentContext.songs, ...newItems];
                        displaySongs(newItems, 'searchResultsGrid', true);
                    } else if (searchType === 'albums') {
                        currentContext.albums = [...currentContext.albums, ...newItems];
                        displayAlbums(newItems, 'searchResultsGrid', true);
                    } else if (searchType === 'playlists') {
                        currentContext.playlists = [...currentContext.playlists, ...newItems];
                        displayPlaylists(newItems, 'searchResultsGrid', true);
                    } else if (searchType === 'artists') {
                        currentContext.artists = [...currentContext.artists, ...newItems];
                        displayArtists(newItems, 'searchResultsGrid', true);
                    }

                    const currentCount = document.querySelectorAll('#searchResultsGrid .card').length;
                    document.getElementById('searchResultsInfo').innerHTML = `
                        <span><i class="fas fa-check-circle"></i> Showing ${currentCount} results</span>
                    `;

                    currentContext.hasMore = data.data.results.length === 20;
                    showToast(`+${newItems.length} loaded`, 'success');
                } else {
                    currentContext.hasMore = false;
                }

            } else if (currentContext.type === 'playlist') {
                endpoint = `/api/playlists?id=${currentContext.id}&page=${currentContext.currentPage}&limit=20`;
                data = await fetchAPI(endpoint);

                if (data?.data?.songs && data.data.songs.length > 0) {
                    let newSongs = [];

                    if (!currentContext.loadedIds) {
                        currentContext.loadedIds = new Set(currentContext.songs.map(s => s.id));
                    }

                    data.data.songs.forEach(song => {
                        if (!currentContext.loadedIds.has(song.id)) {
                            newSongs.push(song);
                            currentContext.loadedIds.add(song.id);
                        }
                    });

                    if (newSongs.length === 0) {
                        currentContext.isLoading = false;
                        btn.disabled = false;
                        btnText.textContent = 'Load More';
                        setTimeout(() => loadMore(), 100);
                        return;
                    }

                    currentContext.songs = [...currentContext.songs, ...newSongs];
                    displaySongs(newSongs, 'searchResultsGrid', true);

                    const infoMsg = currentContext.totalSongs !== '?' 
                        ? `Loaded ${currentContext.songs.length} songs (Total: ${currentContext.totalSongs})` 
                        : `Loaded ${currentContext.songs.length} songs`;

                    document.getElementById('searchResultsInfo').innerHTML = `
                        <span><i class="fas fa-music"></i> ${infoMsg}</span>
                    `;

                    currentContext.hasMore = data.data.songs.length === 20;
                    showToast(`+${newSongs.length} songs`, 'success');
                } else {
                    currentContext.hasMore = false;
                }

            } else if (currentContext.type === 'artist') {
                endpoint = `/api/artists/${currentContext.id}/songs?page=${currentContext.currentPage}&sortBy=popularity&sortOrder=desc`;
                data = await fetchAPI(endpoint);

                if (data?.data?.songs && data.data.songs.length > 0) {
                    let newSongs = [];

                    if (!currentContext.loadedIds) {
                        currentContext.loadedIds = new Set(currentContext.songs.map(s => s.id));
                    }

                    data.data.songs.forEach(song => {
                        if (!currentContext.loadedIds.has(song.id)) {
                            newSongs.push(song);
                            currentContext.loadedIds.add(song.id);
                        }
                    });

                    if (newSongs.length === 0) {
                        currentContext.isLoading = false;
                        btn.disabled = false;
                        btnText.textContent = 'Load More';
                        setTimeout(() => loadMore(), 100);
                        return;
                    }

                    currentContext.songs = [...currentContext.songs, ...newSongs];
                    displaySongs(newSongs, 'searchResultsGrid', true);

                    const infoMsg = currentContext.totalSongs > 0
                        ? `Loaded ${currentContext.songs.length} of ${currentContext.totalSongs} songs` 
                        : `Loaded ${currentContext.songs.length} songs`;

                    document.getElementById('searchResultsInfo').innerHTML = `
                        <span><i class="fas fa-music"></i> ${infoMsg}</span>
                    `;

                    currentContext.hasMore = data.data.songs.length >= 10;
                    showToast(`+${newSongs.length} songs`, 'success');
                } else {
                    currentContext.hasMore = false;
                }
            }

            if (!currentContext.hasMore) {
                document.getElementById('loadMoreContainer').classList.remove('active');
                const totalLoaded = currentContext.songs?.length || 
                                   currentContext.albums?.length || 
                                   currentContext.playlists?.length || 
                                   currentContext.artists?.length || 
                                   document.querySelectorAll('#searchResultsGrid .card').length;
                showToast(`All loaded! Total: ${totalLoaded}`, 'success');
            }

            btn.disabled = false;
            btnText.textContent = 'Load More';
            currentContext.isLoading = false;
        }

        function displaySongs(songs, gridId, append = false) {
            const grid = document.getElementById(gridId);

            if (!songs?.length) {
                if (!append) grid.innerHTML = '<div class="empty-state"><i class="fas fa-music"></i><p>No songs found</p></div>';
                return;
            }

            const songsHTML = songs.map((song, index) => {
                const imageUrl = song.image?.[2]?.url || song.image?.[1]?.url || 'https://via.placeholder.com/200';
                const artistName = song.artists?.primary?.map(a => a.name).join(', ') || 'Unknown Artist';
                const isFav = favorites.find(f => f.id === song.id);
                const songIndex = append ? (currentContext.songs.length - songs.length + index) : index;

                return `
                    <div class="card">
                        <div class="card-img-container">
                            <img src="${imageUrl}" class="card-img" loading="lazy" onerror="this.src='https://via.placeholder.com/200'">
                            ${song.duration ? `<div class="card-badge"><i class="fas fa-clock"></i> ${formatTime(song.duration)}</div>` : ''}
                            <div class="play-overlay" onclick="event.stopPropagation(); playSongByIndex(${songIndex})">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                        <div class="card-title">${song.name || 'Unknown Song'}</div>
                        <div class="card-subtitle">${artistName}</div>
                        <div class="card-actions">
                            <button class="icon-btn" onclick="event.stopPropagation(); addSongToQueue(${songIndex})" title="Add to queue">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="icon-btn ${isFav ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavoriteSongByIndex(${songIndex})" title="Favorite">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button class="icon-btn" onclick="event.stopPropagation(); downloadSongByIndex(${songIndex})" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="icon-btn" onclick="event.stopPropagation(); addSongToPlaylistByIndex(${songIndex})" title="Add to playlist">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = append ? grid.innerHTML + songsHTML : songsHTML;
        }

        function displayAlbums(albums, gridId, append = false) {
            const grid = document.getElementById(gridId);

            if (!albums?.length) {
                if (!append) grid.innerHTML = '<div class="empty-state"><i class="fas fa-compact-disc"></i><p>No albums found</p></div>';
                return;
            }

            const albumsHTML = albums.map(album => {
                const imageUrl = album.image?.[2]?.url || album.image?.[1]?.url || 'https://via.placeholder.com/200';
                const artistName = album.artists?.primary?.map(a => a.name).join(', ') || 'Various Artists';

                return `
                    <div class="card" onclick="loadAlbum('${album.id}', '${escapeHtml(album.name)}')">
                        <div class="card-img-container">
                            <img src="${imageUrl}" class="card-img" loading="lazy">
                            ${album.songCount ? `<div class="card-badge"><i class="fas fa-music"></i> ${album.songCount}</div>` : ''}
                            <div class="play-overlay">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                        <div class="card-title">${album.name}</div>
                        <div class="card-subtitle">${artistName}</div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = append ? grid.innerHTML + albumsHTML : albumsHTML;
        }

        function displayPlaylists(playlists, gridId, append = false) {
            const grid = document.getElementById(gridId);

            if (!playlists?.length) {
                if (!append) grid.innerHTML = '<div class="empty-state"><i class="fas fa-list-music"></i><p>No playlists found</p></div>';
                return;
            }

            const playlistsHTML = playlists.map(playlist => {
                const imageUrl = playlist.image?.[2]?.url || playlist.image?.[1]?.url || 'https://via.placeholder.com/200';

                return `
                    <div class="card" onclick="loadOnlinePlaylist('${playlist.id}', '${encodeURIComponent(playlist.url || '')}', '${escapeHtml(playlist.name)}')">
                        <div class="card-img-container">
                            <img src="${imageUrl}" class="card-img" loading="lazy">
                            ${playlist.songCount ? `<div class="card-badge"><i class="fas fa-music"></i> ${playlist.songCount}</div>` : ''}
                            <div class="play-overlay">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                        <div class="card-title">${playlist.name}</div>
                        <div class="card-subtitle">${playlist.songCount || 0} songs</div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = append ? grid.innerHTML + playlistsHTML : playlistsHTML;
        }

        function displayArtists(artists, gridId, append = false) {
            const grid = document.getElementById(gridId);

            if (!artists?.length) {
                if (!append) grid.innerHTML = '<div class="empty-state"><i class="fas fa-user"></i><p>No artists found</p></div>';
                return;
            }

            const artistsHTML = artists.map(artist => {
                const imageUrl = artist.image?.[2]?.url || artist.image?.[1]?.url || 'https://via.placeholder.com/200';

                return `
                    <div class="card artist-card" onclick="loadArtistSongs('${artist.id}', '${escapeHtml(artist.name)}')">
                        <div class="card-img-container">
                            <img src="${imageUrl}" class="card-img" loading="lazy">
                            <div class="play-overlay">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                        <div class="card-title">${artist.name}</div>
                        <div class="card-subtitle">Artist</div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = append ? grid.innerHTML + artistsHTML : artistsHTML;
        }

        function displayMixedResults(results, gridId, append = false) {
            const grid = document.getElementById(gridId);

            if (!results?.length) {
                if (!append) grid.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>No results found</p></div>';
                return;
            }

            const resultsHTML = results.map(item => {
                const imageUrl = item.image?.[2]?.url || item.image?.[1]?.url || 'https://via.placeholder.com/200';

                if (item.type === 'song') {
                    const songIndex = currentContext.songs.length;
                    currentContext.songs.push(item);

                    return `
                        <div class="card">
                            <div class="card-img-container">
                                <img src="${imageUrl}" class="card-img" loading="lazy">
                                <div class="play-overlay" onclick="event.stopPropagation(); playSongByIndex(${songIndex})">
                                    <i class="fas fa-play"></i>
                                </div>
                            </div>
                            <div class="card-title">${item.name}</div>
                            <div class="card-subtitle">${item.artists?.primary?.map(a => a.name).join(', ') || 'Unknown'}</div>
                        </div>
                    `;
                } else if (item.type === 'album') {
                    return `
                        <div class="card" onclick="loadAlbum('${item.id}', '${escapeHtml(item.name)}')">
                            <div class="card-img-container">
                                <img src="${imageUrl}" class="card-img" loading="lazy">
                                <div class="play-overlay"><i class="fas fa-play"></i></div>
                            </div>
                            <div class="card-title">${item.name}</div>
                            <div class="card-subtitle">Album</div>
                        </div>
                    `;
                } else if (item.type === 'playlist') {
                    return `
                        <div class="card" onclick="loadOnlinePlaylist('${item.id}', '${encodeURIComponent(item.url || '')}', '${escapeHtml(item.name)}')">
                            <div class="card-img-container">
                                <img src="${imageUrl}" class="card-img" loading="lazy">
                                <div class="play-overlay"><i class="fas fa-play"></i></div>
                            </div>
                            <div class="card-title">${item.name}</div>
                            <div class="card-subtitle">Playlist</div>
                        </div>
                    `;
                } else if (item.type === 'artist') {
                    return `
                        <div class="card artist-card" onclick="loadArtistSongs('${item.id}', '${escapeHtml(item.name)}')">
                            <div class="card-img-container">
                                <img src="${imageUrl}" class="card-img" loading="lazy">
                                <div class="play-overlay"><i class="fas fa-play"></i></div>
                            </div>
                            <div class="card-title">${item.name}</div>
                            <div class="card-subtitle">Artist</div>
                        </div>
                    `;
                }
                return '';
            }).join('');

            grid.innerHTML = append ? grid.innerHTML + resultsHTML : resultsHTML;
        }

        function playSongByIndex(index) {
            if (currentContext.songs[index]) {
                playSongFromData(currentContext.songs[index], index);
            }
        }

        function addSongToQueue(index) {
            if (currentContext.songs[index]) {
                addToQueue(currentContext.songs[index]);
            }
        }

        function toggleFavoriteSongByIndex(index) {
            if (currentContext.songs[index]) {
                toggleFavoriteSong(currentContext.songs[index]);
            }
        }

        function downloadSongByIndex(index) {
            if (currentContext.songs[index]) {
                downloadSong(currentContext.songs[index]);
            }
        }

        function addSongToPlaylistByIndex(index) {
            if (currentContext.songs[index]) {
                currentPlaylistForAdd = currentContext.songs[index];
                currentSong = currentContext.songs[index];
                openAddToPlaylist();
            }
        }

        async function loadAlbum(albumId, albumName) {
            showLoading('searchResultsGrid');
            switchTab('search-results');
            document.getElementById('searchResultsTitle').innerHTML = `<i class="fas fa-compact-disc"></i> ${albumName}`;
            document.getElementById('loadMoreContainer').classList.remove('active');

            currentContext = {
                type: 'album',
                id: albumId,
                name: albumName,
                songs: [],
                currentPage: 0,
                totalSongs: 0,
                hasMore: false,
                isLoading: false
            };

            const data = await fetchAPI(`/api/albums?id=${albumId}`);
            if (data?.data?.songs) {
                currentContext.songs = data.data.songs;
                currentContext.totalSongs = data.data.songs.length;
                displaySongs(data.data.songs, 'searchResultsGrid');
                document.getElementById('searchResultsInfo').innerHTML = `<span><i class="fas fa-music"></i> ${data.data.songs.length} songs</span>`;
            }
        }

        async function loadOnlinePlaylist(playlistId, playlistUrl, playlistName) {
            showLoading('searchResultsGrid');
            switchTab('search-results');
            document.getElementById('searchResultsTitle').innerHTML = `<i class="fas fa-list-music"></i> ${playlistName}`;
            document.getElementById('loadMoreContainer').classList.remove('active');

            currentContext = {
                type: 'playlist',
                id: playlistId,
                url: decodeURIComponent(playlistUrl),
                name: playlistName,
                songs: [],
                currentPage: 0,
                totalSongs: 0,
                hasMore: false,
                isLoading: false,
                loadedIds: new Set(),
                useBackupAPI: false
            };

            const endpoint = `/api/playlists?id=${playlistId}&page=0&limit=20`;
            const data = await fetchAPI(endpoint);

            if (data?.data?.songs && data.data.songs.length > 0) {
                currentContext.songs = data.data.songs;
                data.data.songs.forEach(s => currentContext.loadedIds.add(s.id));
                currentContext.hasMore = data.data.songs.length === 20;
                currentContext.totalSongs = data.data.songCount || '?';

                displaySongs(data.data.songs, 'searchResultsGrid');

                const infoMsg = currentContext.totalSongs !== '?' 
                    ? `Showing ${data.data.songs.length} songs (Total: ${currentContext.totalSongs})` 
                    : `Loaded ${data.data.songs.length} songs`;

                document.getElementById('searchResultsInfo').innerHTML = `
                    <span><i class="fas fa-music"></i> ${infoMsg}</span>
                `;

                if (currentContext.hasMore) {
                    document.getElementById('loadMoreContainer').classList.add('active');
                }
            } else {
                try {
                    const backupEndpoint = `https://jiosaavn-api-codyandersan.vercel.app/playlists?id=${playlistId}`;
                    const backupResponse = await fetch(backupEndpoint);
                    const backupData = await backupResponse.json();

                    let songs = null;

                    if (backupData?.data?.songs && backupData.data.songs.length > 0) {
                        songs = backupData.data.songs;
                    } else if (backupData?.songs && backupData.songs.length > 0) {
                        songs = backupData.songs;
                    } else if (Array.isArray(backupData) && backupData.length > 0) {
                        songs = backupData;
                    }

                    if (songs && songs.length > 0) {
                        const normalizedSongs = normalizeBackupAPIResponse(songs);

                        currentContext.useBackupAPI = true;
                        currentContext.songs = normalizedSongs;
                        normalizedSongs.forEach(s => currentContext.loadedIds.add(s.id));
                        currentContext.hasMore = false;
                        currentContext.totalSongs = normalizedSongs.length;

                        displaySongs(normalizedSongs, 'searchResultsGrid');

                        document.getElementById('searchResultsInfo').innerHTML = `
                            <span><i class="fas fa-music"></i> ${normalizedSongs.length} songs loaded</span>
                            <span style="margin-left: 1rem; color: var(--accent-secondary);"><i class="fas fa-info-circle"></i> Using alternate source</span>
                        `;

                        showToast(`✓ Loaded ${normalizedSongs.length} songs from backup`, 'success');
                    } else {
                        document.getElementById('searchResultsGrid').innerHTML = '<div class="empty-state"><i class="fas fa-music"></i><p>No songs found in this playlist</p></div>';
                        document.getElementById('searchResultsInfo').innerHTML = '';
                    }
                } catch (error) {
                    document.getElementById('searchResultsGrid').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Failed to load playlist</p></div>';
                    document.getElementById('searchResultsInfo').innerHTML = '';
                }
            }
        }

        async function loadArtistSongs(artistId, artistName) {
            showLoading('searchResultsGrid');
            switchTab('search-results');
            document.getElementById('searchResultsTitle').innerHTML = `<i class="fas fa-user"></i> ${artistName}`;
            document.getElementById('loadMoreContainer').classList.remove('active');

            currentContext = {
                type: 'artist',
                id: artistId,
                name: artistName,
                songs: [],
                currentPage: 0,
                totalSongs: 0,
                hasMore: false,
                isLoading: false,
                loadedIds: new Set()
            };

            const endpoint = `/api/artists/${artistId}/songs?page=0&sortBy=popularity&sortOrder=desc`;
            const data = await fetchAPI(endpoint);

            if (data?.data?.songs && data.data.songs.length > 0) {
                currentContext.songs = data.data.songs;
                data.data.songs.forEach(s => currentContext.loadedIds.add(s.id));
                currentContext.totalSongs = data.data.total || data.data.songs.length;
                currentContext.hasMore = data.data.songs.length >= 10;

                displaySongs(data.data.songs, 'searchResultsGrid');

                const infoMsg = currentContext.totalSongs > 0
                    ? `Showing ${data.data.songs.length} of ${currentContext.totalSongs} songs` 
                    : `Loaded ${data.data.songs.length} songs`;

                document.getElementById('searchResultsInfo').innerHTML = `
                    <span><i class="fas fa-music"></i> ${infoMsg}</span>
                `;

                if (currentContext.hasMore) {
                    document.getElementById('loadMoreContainer').classList.add('active');
                }
            } else {
                document.getElementById('searchResultsGrid').innerHTML = '<div class="empty-state"><i class="fas fa-music"></i><p>No songs found</p></div>';
            }
        }

        async function playSongFromData(song, songIndex = -1) {
            if (!song.downloadUrl?.length) {
                const songData = await fetchAPI(`/api/songs?id=${song.id}`);
                if (songData?.data?.[0]) {
                    song = songData.data[0];
                    if (songIndex >= 0 && currentContext.songs[songIndex]) {
                        currentContext.songs[songIndex] = song;
                    }
                }
            }
            playSong(song, songIndex);
        }

        // ✅ IMPROVED PLAY SONG FUNCTION
        function playSong(song, songIndex = -1) {
            currentSong = song;

            const quality = settings.audioQuality;
            let downloadUrl = null;

            if (song.downloadUrl && song.downloadUrl.length > 0) {
                if (quality === 'high' && song.downloadUrl[4]?.url) {
                    downloadUrl = song.downloadUrl[4].url;
                } else if (quality === 'medium' && song.downloadUrl[3]?.url) {
                    downloadUrl = song.downloadUrl[3].url;
                } else if (quality === 'low' && song.downloadUrl[2]?.url) {
                    downloadUrl = song.downloadUrl[2].url;
                } else {
                    for (let i = song.downloadUrl.length - 1; i >= 0; i--) {
                        if (song.downloadUrl[i]?.url) {
                            downloadUrl = song.downloadUrl[i].url;
                            break;
                        }
                    }
                }
            }

            if (downloadUrl) {
                audio.src = downloadUrl;
                audio.playbackRate = settings.playbackSpeed;
                audio.preload = 'auto';

                audio.play()
                    .then(() => {
                        isPlaying = true;
                        updatePlayPauseButtons(); // ✅ Update after play succeeds
                        updatePlayerUI();
                        updateFullscreenPlayerUI();
                        requestWakeLock();
                    })
                    .catch(err => {
                        console.error('Play error:', err);
                        isPlaying = false;
                        updatePlayPauseButtons();
                        showToast('Playback failed', 'error');
                    });

                addToRecentlyPlayed(song);
                setupMediaSession(song);
            } else {
                console.error('No download URL found');
                showToast('Song URL unavailable', 'error');
                return;
            }

            if (currentContext.type && currentContext.songs.length > 0) {
                queue = [...currentContext.songs];
                currentIndex = songIndex >= 0 ? songIndex : queue.findIndex(s => s.id === song.id);
            } else {
                if (!queue.find(s => s.id === song.id)) {
                    queue.push(song);
                }
                currentIndex = queue.findIndex(s => s.id === song.id);
            }

            updateQueueDisplay();
            updateBadges();
            updateStats();
        }

        // ✅ IMPROVED TOGGLE PLAY/PAUSE - FIXES BUTTON SYNC ISSUE
        function togglePlayPause(event) {
            if (event) event.stopPropagation();

            if (!currentSong) {
                showToast('No song selected', 'warning');
                return;
            }

            if (isPlaying) {
                // PAUSE
                audio.pause();
                isPlaying = false;
                updatePlayPauseButtons();
                releaseWakeLock();
            } else {
                // PLAY
                audio.play()
                    .then(() => {
                        isPlaying = true;
                        updatePlayPauseButtons(); // ✅ Update AFTER play succeeds
                        requestWakeLock();
                    })
                    .catch(err => {
                        console.error('Play failed:', err);
                        isPlaying = false;
                        updatePlayPauseButtons();
                        showToast('Playback failed', 'error');
                    });
            }
        }

        function updatePlayPauseButtons() {
            const icon = isPlaying ? 'pause' : 'play';
            document.getElementById('playPauseBtn').innerHTML = `<i class="fas fa-${icon}"></i>`;
            document.getElementById('playPauseBtnMini').innerHTML = `<i class="fas fa-${icon}"></i>`;

            const fullscreenBtn = document.getElementById('fullscreenPlayPauseBtn');
            if (fullscreenBtn) fullscreenBtn.innerHTML = `<i class="fas fa-${icon}"></i>`;
        }

        function previousSong() {
            if (currentIndex > 0) {
                currentIndex--;
                playSongFromData(queue[currentIndex], currentIndex);
                updateQueueDisplay();
            } else {
                showToast('First song in queue', 'info');
            }
        }

        function nextSong(event) {
            if (event) event.stopPropagation();

            if (queue.length === 0) {
                showToast('Queue is empty', 'warning');
                return;
            }

            if (repeatMode === 'all' && currentIndex === queue.length - 1) {
                currentIndex = 0;
                playSongFromData(queue[currentIndex], currentIndex);
            } else if (currentIndex < queue.length - 1) {
                if (isShuffleOn) {
                    currentIndex = Math.floor(Math.random() * queue.length);
                } else {
                    currentIndex++;
                }
                playSongFromData(queue[currentIndex], currentIndex);
            } else {
                showToast('Last song in queue', 'info');
                audio.pause();
                isPlaying = false;
                updatePlayPauseButtons();
            }

            updateQueueDisplay();
        }

        function addToQueue(song) {
            if (!queue.find(s => s.id === song.id)) {
                queue.push(song);
                updateQueueDisplay();
                updateBadges();
                showToast('Added to queue', 'success');
            } else {
                showToast('Already in queue', 'info');
            }
        }

        function clearQueue() {
            if (confirm('Clear entire queue?')) {
                queue = [];
                currentIndex = -1;
                updateQueueDisplay();
                updateBadges();
                showToast('Queue cleared', 'success');
            }
        }

        function updateQueueDisplay() {
            const queueList = document.getElementById('queueList');
            document.getElementById('queueCount').textContent = queue.length;

            if (!queue.length) {
                queueList.innerHTML = '<div class="empty-state"><i class="fas fa-list"></i><p>Queue is empty</p></div>';
                updateFullscreenQueue();
                return;
            }

            queueList.innerHTML = queue.map((song, index) => {
                const imageUrl = song.image?.[1]?.url || 'https://via.placeholder.com/48';
                const artistName = song.artists?.primary?.map(a => a.name).join(', ') || 'Unknown Artist';

                return `
                    <div class="queue-item ${index === currentIndex ? 'active' : ''}" onclick="playFromQueue(${index})">
                        <img src="${imageUrl}" class="queue-img" loading="lazy">
                        <div class="queue-info">
                            <div class="title">${song.name || 'Unknown Song'}</div>
                            <div class="artist">${artistName}</div>
                        </div>
                        <button class="icon-btn" onclick="removeFromQueue(${index}, event)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');

            updateFullscreenQueue();
        }

        function playFromQueue(index) {
            currentIndex = index;
            playSongFromData(queue[index], index);
            updateQueueDisplay();
        }

        function removeFromQueue(index, event) {
            event.stopPropagation();
            queue.splice(index, 1);
            if (currentIndex >= index && currentIndex > 0) currentIndex--;
            updateQueueDisplay();
            updateBadges();
        }

        function toggleShuffle() {
            isShuffleOn = !isShuffleOn;
            const btn = document.getElementById('shuffleBtn');
            const fullscreenBtn = document.getElementById('fullscreenShuffleBtn');

            if (btn) btn.classList.toggle('active');
            if (fullscreenBtn) fullscreenBtn.classList.toggle('active');

            showToast(isShuffleOn ? 'Shuffle on' : 'Shuffle off', 'info');
        }

        function toggleRepeat() {
            const modes = ['off', 'all', 'one'];
            const currentModeIndex = modes.indexOf(repeatMode);
            repeatMode = modes[(currentModeIndex + 1) % modes.length];

            const btn = document.getElementById('repeatBtn');
            const fullscreenBtn = document.getElementById('fullscreenRepeatBtn');

            if (repeatMode === 'off') {
                if (btn) {
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="fas fa-redo"></i>';
                }
                if (fullscreenBtn) {
                    fullscreenBtn.classList.remove('active');
                    fullscreenBtn.innerHTML = '<i class="fas fa-redo"></i>';
                }
            } else if (repeatMode === 'all') {
                if (btn) {
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-redo"></i>';
                }
                if (fullscreenBtn) {
                    fullscreenBtn.classList.add('active');
                    fullscreenBtn.innerHTML = '<i class="fas fa-redo"></i>';
                }
            } else {
                if (btn) {
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-redo"></i><span style="font-size: 0.6rem; position: absolute; bottom: 8px; right: 8px;">1</span>';
                }
                if (fullscreenBtn) {
                    fullscreenBtn.classList.add('active');
                    fullscreenBtn.innerHTML = '<i class="fas fa-redo"></i><span style="font-size: 0.6rem; position: absolute; bottom: 12px; right: 12px;">1</span>';
                }
            }

            showToast(`Repeat: ${repeatMode}`, 'info');
        }

        function togglePlayerExpand() {
            if (event.target.closest('.player-mini-controls')) return;

            playerExpanded = !playerExpanded;
            const playerFull = document.getElementById('playerFull');
            playerFull.classList.toggle('active');
        }

        function updatePlayerUI() {
            if (currentSong) {
                const imageUrl = currentSong.image?.[2]?.url || currentSong.image?.[1]?.url || 'https://via.placeholder.com/400';
                const artistName = currentSong.artists?.primary?.map(a => a.name).join(', ') || 'Unknown Artist';

                document.getElementById('playerImgMini').src = imageUrl;
                document.getElementById('playerTitleMini').textContent = currentSong.name || 'Unknown Song';
                document.getElementById('playerArtistMini').textContent = artistName;

                updateFavoriteIcon();
            }
        }

        function updateFullscreenPlayerUI() {
            if (currentSong) {
                const imageUrl = currentSong.image?.[2]?.url || currentSong.image?.[1]?.url || 'https://via.placeholder.com/400';
                const artistName = currentSong.artists?.primary?.map(a => a.name).join(', ') || 'Unknown Artist';

                document.getElementById('fullscreenImg').src = imageUrl;
                document.getElementById('fullscreenTitle').textContent = currentSong.name || 'Unknown Song';
                document.getElementById('fullscreenArtist').textContent = artistName;

                const isFav = favorites.find(f => f.id === currentSong.id);
                const fullscreenFavIcon = document.getElementById('fullscreenFavoriteIcon');
                if (fullscreenFavIcon) {
                    fullscreenFavIcon.className = isFav ? 'fas fa-heart' : 'far fa-heart';
                    fullscreenFavIcon.style.color = isFav ? 'var(--accent-primary)' : '';
                }

                const shuffleBtn = document.getElementById('fullscreenShuffleBtn');
                const repeatBtn = document.getElementById('fullscreenRepeatBtn');

                if (isShuffleOn && shuffleBtn) shuffleBtn.classList.add('active');
                else if (shuffleBtn) shuffleBtn.classList.remove('active');

                if (repeatMode !== 'off' && repeatBtn) {
                    repeatBtn.classList.add('active');
                    if (repeatMode === 'one') {
                        repeatBtn.innerHTML = '<i class="fas fa-redo"></i><span style="font-size: 0.6rem; position: absolute; bottom: 12px; right: 12px;">1</span>';
                    } else {
                        repeatBtn.innerHTML = '<i class="fas fa-redo"></i>';
                    }
                } else if (repeatBtn) {
                    repeatBtn.classList.remove('active');
                    repeatBtn.innerHTML = '<i class="fas fa-redo"></i>';
                }
            }
        }

        function toggleFullscreenQueue() {
            if (window.innerWidth < 1024) {
                const player = document.getElementById('fullscreenPlayer');
                player.classList.toggle('queue-open');
                updateFullscreenQueue();
            }
        }

        function updateFullscreenQueue() {
            const queueList = document.getElementById('fullscreenQueueList');

            if (!queueList) return;

            if (!queue.length) {
                queueList.innerHTML = '<div class="empty-state"><i class="fas fa-list"></i><p>Queue is empty</p></div>';
                return;
            }

            queueList.innerHTML = queue.map((song, index) => {
                const imageUrl = song.image?.[1]?.url || 'https://via.placeholder.com/48';
                const artistName = song.artists?.primary?.map(a => a.name).join(', ') || 'Unknown Artist';

                return `
                    <div class="queue-item ${index === currentIndex ? 'active' : ''}" onclick="playFromQueue(${index})">
                        <img src="${imageUrl}" class="queue-img" loading="lazy">
                        <div class="queue-info">
                            <div class="title">${song.name || 'Unknown Song'}</div>
                            <div class="artist">${artistName}</div>
                        </div>
                        <button class="icon-btn" onclick="removeFromQueue(${index}, event)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function seekSongFullscreen(event) {
            if (!audio.duration) return;
            const rect = event.currentTarget.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audio.currentTime = percent * audio.duration;
        }

        function updateProgress() {
            if (audio.duration) {
                const percent = (audio.currentTime / audio.duration) * 100;
                document.getElementById('progressFilled').style.width = percent + '%';
                document.getElementById('currentTime').textContent = formatTime(audio.currentTime);

                const fullscreenFilled = document.getElementById('fullscreenProgressFilled');
                const fullscreenTime = document.getElementById('fullscreenCurrentTime');
                const fullscreenDur = document.getElementById('fullscreenDuration');

                if (fullscreenFilled) fullscreenFilled.style.width = percent + '%';
                if (fullscreenTime) fullscreenTime.textContent = formatTime(audio.currentTime);
                if (fullscreenDur) fullscreenDur.textContent = formatTime(audio.duration);
            }
        }

        function seekSong(event) {
            if (!audio.duration) return;
            const rect = event.currentTarget.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audio.currentTime = percent * audio.duration;
        }

        function setVolume(event) {
            const rect = event.currentTarget.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audio.volume = percent;
            document.getElementById('volumeFilled').style.width = (percent * 100) + '%';
        }

        function downloadSong(song) {
            const downloadUrl = song.downloadUrl?.[4]?.url || song.downloadUrl?.[3]?.url || song.downloadUrl?.[2]?.url;
            if (downloadUrl) {
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `${song.name}.mp3`;
                a.click();
                showToast('Download started', 'success');
            } else {
                showToast('Download unavailable', 'error');
            }
        }

        function downloadCurrentSong() {
            if (currentSong) downloadSong(currentSong);
            else showToast('No song playing', 'warning');
        }

        function shareCurrentSong() {
            if (!currentSong) {
                showToast('No song playing', 'warning');
                return;
            }

            const shareText = `🎵 ${currentSong.name} - ${currentSong.artists?.primary?.map(a => a.name).join(', ')}`;

            if (navigator.share) {
                navigator.share({
                    title: currentSong.name,
                    text: shareText,
                    url: currentSong.url || window.location.href
                }).then(() => {
                    showToast('Shared successfully', 'success');
                }).catch(() => {
                    copyToClipboard(shareText);
                });
            } else {
                copyToClipboard(shareText);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard', 'success');
            });
        }

        function toggleFavorite(event) {
            event.stopPropagation();
            if (!currentSong) return;
            toggleFavoriteSong(currentSong);
        }

        function toggleFavoriteSong(song) {
            const index = favorites.findIndex(f => f.id === song.id);
            if (index > -1) {
                favorites.splice(index, 1);
                showToast('Removed from favorites', 'info');
            } else {
                favorites.push(song);
                showToast('Added to favorites', 'success');
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateFavoriteIcon();
            updateBadges();
            updateStats();
            updateFullscreenPlayerUI();
        }

        function updateFavoriteIcon() {
            const isFav = currentSong && favorites.find(f => f.id === currentSong.id);
            const icon = document.getElementById('favoriteIcon');
            if (icon) {
                icon.className = isFav ? 'fas fa-heart' : 'far fa-heart';
                icon.style.color = isFav ? 'var(--accent-primary)' : '';
            }

            const fullscreenIcon = document.getElementById('fullscreenFavoriteIcon');
            if (fullscreenIcon) {
                fullscreenIcon.className = isFav ? 'fas fa-heart' : 'far fa-heart';
                fullscreenIcon.style.color = isFav ? 'var(--accent-primary)' : '';
            }
        }

        function openFavorites() {
            displayFavorites();
            openModal('favoritesModal');
        }

        function displayFavorites() {
            const list = document.getElementById('favoritesList');

            if (!favorites.length) {
                list.innerHTML = '<div class="empty-state"><i class="fas fa-heart"></i><p>No favorites yet</p></div>';
                return;
            }

            list.innerHTML = favorites.map(song => {
                const imageUrl = song.image?.[1]?.url || 'https://via.placeholder.com/48';
                const artistName = song.artists?.primary?.map(a => a.name).join(', ') || 'Unknown Artist';

                return `
                    <div class="queue-item" onclick="playSongFromFavorites('${song.id}')">
                        <img src="${imageUrl}" class="queue-img" loading="lazy">
                        <div class="queue-info">
                            <div class="title">${song.name}</div>
                            <div class="artist">${artistName}</div>
                        </div>
                        <button class="icon-btn" onclick="removeFavorite('${song.id}', event)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function playSongFromFavorites(songId) {
            const song = favorites.find(s => s.id === songId);
            if (song) {
                playSongFromData(song);
                closeModal('favoritesModal');
            }
        }

        function removeFavorite(songId, event) {
            event.stopPropagation();
            favorites = favorites.filter(f => f.id !== songId);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            displayFavorites();
            updateBadges();
            updateStats();
        }

        function addToRecentlyPlayed(song) {
            const index = recentlyPlayed.findIndex(s => s.id === song.id);
            if (index > -1) {
                recentlyPlayed.splice(index, 1);
            }
            recentlyPlayed.unshift(song);
            recentlyPlayed = recentlyPlayed.slice(0, 50);
            localStorage.setItem('recentlyPlayed', JSON.stringify(recentlyPlayed));
            updateBadges();
        }

        function openRecentlyPlayed() {
            displayRecentlyPlayed();
            openModal('recentModal');
        }

        function displayRecentlyPlayed() {
            const list = document.getElementById('recentList');

            if (!recentlyPlayed.length) {
                list.innerHTML = '<div class="empty-state"><i class="fas fa-history"></i><p>No recent songs</p></div>';
                return;
            }

            list.innerHTML = recentlyPlayed.map(song => {
                const imageUrl = song.image?.[1]?.url || 'https://via.placeholder.com/48';
                const artistName = song.artists?.primary?.map(a => a.name).join(', ') || 'Unknown Artist';

                return `
                    <div class="queue-item" onclick="playSongFromRecent('${song.id}')">
                        <img src="${imageUrl}" class="queue-img" loading="lazy">
                        <div class="queue-info">
                            <div class="title">${song.name}</div>
                            <div class="artist">${artistName}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function playSongFromRecent(songId) {
            const song = recentlyPlayed.find(s => s.id === songId);
            if (song) {
                playSongFromData(song);
                closeModal('recentModal');
            }
        }

        function showCreatePlaylist() {
            closeModal('playlistModal');
            openModal('createPlaylistModal');
        }

        function createPlaylist() {
            const name = document.getElementById('playlistName').value.trim();
            const desc = document.getElementById('playlistDesc').value.trim();

            if (name) {
                playlists.push({
                    id: Date.now().toString(),
                    name: name,
                    description: desc,
                    songs: [],
                    createdAt: new Date().toISOString()
                });
                savePlaylists();
                document.getElementById('playlistName').value = '';
                document.getElementById('playlistDesc').value = '';
                closeModal('createPlaylistModal');
                updateMyPlaylistsDisplay();
                updateStats();
                showToast('Playlist created', 'success');
            } else {
                showToast('Enter playlist name', 'warning');
            }
        }

        function openAddToPlaylist() {
            if (!currentSong && !currentPlaylistForAdd) {
                showToast('No song selected', 'warning');
                return;
            }

            if (!playlists.length) {
                showToast('Create a playlist first', 'info');
                showCreatePlaylist();
                return;
            }

            const list = document.getElementById('addToPlaylistList');
            list.innerHTML = playlists.map(playlist => `
                <div class="playlist-item" onclick="addToPlaylistAction('${playlist.id}')">
                    <div>
                        <div style="font-weight: 600; font-size: 0.85rem;">${playlist.name}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${playlist.songs.length} songs</div>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
            `).join('');

            openModal('addToPlaylistModal');
        }

        function addToPlaylistAction(playlistId) {
            const playlist = playlists.find(p => p.id === playlistId);
            const songToAdd = currentPlaylistForAdd || currentSong;

            if (playlist && songToAdd) {
                if (!playlist.songs.find(s => s.id === songToAdd.id)) {
                    playlist.songs.push(songToAdd);
                    savePlaylists();
                    updateMyPlaylistsDisplay();
                    showToast('Added to playlist', 'success');
                } else {
                    showToast('Already in playlist', 'info');
                }
            }
            closeModal('addToPlaylistModal');
            currentPlaylistForAdd = null;
        }

        function updateMyPlaylistsDisplay() {
            const grid = document.getElementById('myPlaylistsGrid');

            if (!playlists.length) {
                grid.innerHTML = '<div class="empty-state"><i class="fas fa-heart"></i><p>No playlists yet</p></div>';
                return;
            }

            grid.innerHTML = playlists.map(playlist => {
                const firstSongImage = playlist.songs[0]?.image?.[1]?.url;

                return `
                <div class="card">
                    <div class="card-img-container" style="${firstSongImage ? `background-image: url(${firstSongImage}); background-size: cover;` : 'background: var(--accent-gradient);'} display: flex; align-items: center; justify-content: center;">
                        ${!firstSongImage ? '<i class="fas fa-music" style="font-size: 2.5rem; color: white; opacity: 0.8;"></i>' : ''}
                        <div class="play-overlay" onclick='event.stopPropagation(); playUserPlaylist(${JSON.stringify(playlist).replace(/'/g, "&#39;")})'>
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <div class="card-title">${playlist.name}</div>
                    <div class="card-subtitle">${playlist.songs.length} songs</div>
                    <div class="card-actions">
                        <button class="icon-btn" onclick='event.stopPropagation(); viewUserPlaylist(${JSON.stringify(playlist).replace(/'/g, "&#39;")})' title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn" onclick='event.stopPropagation(); playUserPlaylist(${JSON.stringify(playlist).replace(/'/g, "&#39;")})' title="Play">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="icon-btn" onclick="event.stopPropagation(); deletePlaylist('${playlist.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function viewUserPlaylist(playlist) {
            closeModal('playlistModal');
            document.getElementById('viewPlaylistTitle').textContent = playlist.name;

            const container = document.getElementById('viewPlaylistSongs');

            if (!playlist.songs.length) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-music"></i><p>No songs in playlist</p></div>';
            } else {
                container.innerHTML = playlist.songs.map((song, index) => {
                    const imageUrl = song.image?.[1]?.url || 'https://via.placeholder.com/48';
                    const artistName = song.artists?.primary?.map(a => a.name).join(', ') || 'Unknown Artist';

                    return `
                        <div class="queue-item" onclick="playSongFromMyPlaylist('${playlist.id}', ${index})">
                            <img src="${imageUrl}" class="queue-img" loading="lazy">
                            <div class="queue-info">
                                <div class="title">${song.name}</div>
                                <div class="artist">${artistName}</div>
                            </div>
                            <button class="icon-btn" onclick="removeSongFromPlaylist('${playlist.id}', ${index}, event)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }

            openModal('viewPlaylistModal');
        }

        function playSongFromMyPlaylist(playlistId, songIndex) {
            const playlist = playlists.find(p => p.id === playlistId);
            if (playlist && playlist.songs[songIndex]) {
                currentContext = {
                    type: 'myplaylist',
                    id: playlistId,
                    name: playlist.name,
                    songs: playlist.songs,
                    currentPage: 0,
                    totalSongs: playlist.songs.length,
                    hasMore: false,
                    isLoading: false
                };

                queue = [...playlist.songs];
                currentIndex = songIndex;
                playSongFromData(playlist.songs[songIndex], songIndex);
                closeModal('viewPlaylistModal');
            }
        }

        function playUserPlaylist(playlist) {
            if (!playlist.songs.length) {
                showToast('Playlist is empty', 'warning');
                return;
            }

            currentContext = {
                type: 'myplaylist',
                id: playlist.id,
                name: playlist.name,
                songs: playlist.songs,
                currentPage: 0,
                totalSongs: playlist.songs.length,
                hasMore: false,
                isLoading: false
            };

            queue = [...playlist.songs];
            currentIndex = 0;
            playSongFromData(queue[0], 0);
            closeModal('playlistModal');
            switchTab('queue');
        }

        function deletePlaylist(id) {
            if (confirm('Delete this playlist?')) {
                playlists = playlists.filter(p => p.id !== id);
                savePlaylists();
                updateMyPlaylistsDisplay();
                updateStats();
                showToast('Playlist deleted', 'success');
            }
        }

        function removeSongFromPlaylist(playlistId, songIndex, event) {
            event.stopPropagation();
            const playlist = playlists.find(p => p.id === playlistId);
            if (playlist) {
                playlist.songs.splice(songIndex, 1);
                savePlaylists();
                viewUserPlaylist(playlist);
                updateMyPlaylistsDisplay();
            }
        }

        function savePlaylists() {
            localStorage.setItem('playlists', JSON.stringify(playlists));
        }

        function openSettings() {
            openModal('settingsModal');
        }

        function loadSettings() {
            document.getElementById('audioQuality').value = settings.audioQuality;
            document.getElementById('playbackSpeed').value = settings.playbackSpeed;
        }

        function saveSettings() {
            settings.audioQuality = document.getElementById('audioQuality').value;
            localStorage.setItem('settings', JSON.stringify(settings));
            showToast('Settings saved', 'success');
        }

        function changePlaybackSpeed() {
            settings.playbackSpeed = parseFloat(document.getElementById('playbackSpeed').value);
            audio.playbackRate = settings.playbackSpeed;
            saveSettings();
        }

        function clearAllData() {
            if (confirm('This will delete all your data. Continue?')) {
                localStorage.clear();
                location.reload();
            }
        }

        function openFullscreenPlayer() {
            if (!currentSong) return;
            updatePlayerUI();
            updateFullscreenPlayerUI();
            updateFullscreenQueue();

            const player = document.getElementById('fullscreenPlayer');
            player.classList.add('active');

            if (window.innerWidth >= 1024) {
                player.classList.add('queue-open');
            }

            document.body.style.overflow = 'hidden';
        }

        function closeFullscreenPlayer() {
            document.getElementById('fullscreenPlayer').classList.remove('active');
            document.getElementById('fullscreenPlayer').classList.remove('queue-open');
            document.body.style.overflow = '';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

            document.querySelectorAll('.tab').forEach(tab => {
                const tabText = tab.textContent.toLowerCase().trim();
                const targetText = tabName.toLowerCase().replace('-', ' ').trim();
                if (tabText.includes(targetText.split(' ')[0])) {
                    tab.classList.add('active');
                }
            });

            document.getElementById(tabName).classList.add('active');

            if (tabName === 'trending-playlists' && !document.getElementById('trendingPlaylistsGrid').innerHTML) {
                loadTrendingPlaylists();
            } else if (tabName === 'trending-albums' && !document.getElementById('trendingAlbumsGrid').innerHTML) {
                loadTrendingAlbums();
            } else if (tabName === 'queue') {
                updateQueueDisplay();
            } else if (tabName === 'my-playlists') {
                updateMyPlaylistsDisplay();
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = '';
        }

        function updateBadges() {
            const queueBadge = document.getElementById('queueBadge');
            const sidebarQueueBadge = document.getElementById('sidebarQueueBadge');

            if (queue.length > 0) {
                if (queueBadge) {
                    queueBadge.textContent = queue.length;
                    queueBadge.style.display = 'block';
                }
                if (sidebarQueueBadge) {
                    sidebarQueueBadge.textContent = queue.length;
                    sidebarQueueBadge.style.display = 'block';
                }
            } else {
                if (queueBadge) queueBadge.style.display = 'none';
                if (sidebarQueueBadge) sidebarQueueBadge.style.display = 'none';
            }

            const sidebarFavBadge = document.getElementById('sidebarFavBadge');
            if (favorites.length > 0 && sidebarFavBadge) {
                sidebarFavBadge.textContent = favorites.length;
                sidebarFavBadge.style.display = 'block';
            } else if (sidebarFavBadge) {
                sidebarFavBadge.style.display = 'none';
            }

            const sidebarRecentBadge = document.getElementById('sidebarRecentBadge');
            if (recentlyPlayed.length > 0 && sidebarRecentBadge) {
                sidebarRecentBadge.textContent = recentlyPlayed.length;
                sidebarRecentBadge.style.display = 'block';
            } else if (sidebarRecentBadge) {
                sidebarRecentBadge.style.display = 'none';
            }

            const sidebarPlaylistBadge = document.getElementById('sidebarPlaylistBadge');
            if (playlists.length > 0 && sidebarPlaylistBadge) {
                sidebarPlaylistBadge.textContent = playlists.length;
                sidebarPlaylistBadge.style.display = 'block';
            } else if (sidebarPlaylistBadge) {
                sidebarPlaylistBadge.style.display = 'none';
            }
        }

        function updateStats() {
            const statSongs = document.getElementById('statSongs');
            const statPlaylists = document.getElementById('statPlaylists');
            const statFavorites = document.getElementById('statFavorites');

            if (statSongs) statSongs.textContent = recentlyPlayed.length;
            if (statPlaylists) statPlaylists.textContent = playlists.length;
            if (statFavorites) statFavorites.textContent = favorites.length;

            const sidebarStatSongs = document.getElementById('sidebarStatSongs');
            const sidebarStatPlaylists = document.getElementById('sidebarStatPlaylists');
            const sidebarStatFavorites = document.getElementById('sidebarStatFavorites');

            if (sidebarStatSongs) sidebarStatSongs.textContent = recentlyPlayed.length;
            if (sidebarStatPlaylists) sidebarStatPlaylists.textContent = playlists.length;
            if (sidebarStatFavorites) sidebarStatFavorites.textContent = favorites.length;
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function showLoading(gridId) {
            const grid = document.getElementById(gridId);
            if (grid) grid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
        }

        function showToast(message, type = 'info') {
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fas ${icons[type]}"></i> ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ✅ MOBILE SEARCH FUNCTIONS
        function openMobileSearch() {
            const modal = document.getElementById('mobileSearchModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                document.getElementById('searchInputMobile').focus();
            }, 300);
        }

        function closeMobileSearch() {
            const modal = document.getElementById('mobileSearchModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // ✅ THEME TOGGLE
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            const icon = document.getElementById('themeIcon');

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            if (newTheme === 'light') {
                icon.className = 'fas fa-moon';
            } else {
                icon.className = 'fas fa-sun';
            }

            showToast(`${newTheme === 'light' ? 'Light' : 'Dark'} theme activated`, 'success');
        }

        // ✅ EVENT LISTENERS
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) closeModal(this.id);
            });
        });

        document.addEventListener('click', function(e) {
            const modal = document.getElementById('mobileSearchModal');
            if (modal && modal.classList.contains('active')) {
                if (e.target.classList.contains('mobile-search-overlay')) {
                    closeMobileSearch();
                }
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT') return;

            if (e.key === 'Escape') {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('active')) {
                    closeSidebar();
                }
            }

            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    togglePlayPause();
                    break;
                case 'ArrowRight':
                    nextSong();
                    break;
                case 'ArrowLeft':
                    previousSong();
                    break;
            }
        });

        </script>

        
</body>
</html>
